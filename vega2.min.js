!function(a,b){if("function"==typeof define&&define.amd)define(["d3","topojson"],b);else if("object"==typeof exports)module.exports=b(require("d3"),require("topojson"));else{var c="undefined"==typeof topojson?null:topojson;a.vg=b(d3,c)}}(this,function(a,b){var d,e,f;return function(a){function b(a,b){return u.call(a,b)}function c(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=s.map,p=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(n=n.slice(0,n.length-1),a=a.split("/"),g=a.length-1,s.nodeIdCompat&&w.test(a[g])&&(a[g]=a[g].replace(w,"")),a=n.concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||p)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&p&&p[d]&&(i=p[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function g(b,c){return function(){var d=v.call(arguments,0);return"string"!=typeof d[0]&&1===d.length&&d.push(null),n.apply(a,d.concat([b,c]))}}function h(a){return function(b){return c(b,a)}}function i(a){return function(b){q[a]=b}}function j(c){if(b(r,c)){var d=r[c];delete r[c],t[c]=!0,m.apply(a,d)}if(!b(q,c)&&!b(t,c))throw new Error("No "+c);return q[c]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;o=function(a,b){var d,e=k(a),f=e[0];return a=e[1],f&&(f=c(f,b),d=j(f)),f?a=d&&d.normalize?d.normalize(a,h(b)):c(a,b):(a=c(a,b),e=k(a),f=e[0],a=e[1],f&&(d=j(f))),{f:f?f+"!"+a:a,n:a,pr:f,p:d}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(c,d,e,f){var h,k,l,m,n,s,u=[],v=typeof e;if(f=f||c,"undefined"===v||"function"===v){for(d=!d.length&&e.length?["require","exports","module"]:d,n=0;n<d.length;n+=1)if(m=o(d[n],f),k=m.f,"require"===k)u[n]=p.require(c);else if("exports"===k)u[n]=p.exports(c),s=!0;else if("module"===k)h=u[n]=p.module(c);else if(b(q,k)||b(r,k)||b(t,k))u[n]=j(k);else{if(!m.p)throw new Error(c+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=e?e.apply(q[c],u):void 0,c&&(h&&h.exports!==a&&h.exports!==q[c]?q[c]=h.exports:l===a&&s||(q[c]=l))}else c&&(q[c]=e)},d=e=n=function(b,c,d,e,f){if("string"==typeof b)return p[b]?p[b](c):j(o(b,c).f);if(!b.splice){if(s=b,s.deps&&n(s.deps,s.callback),!c)return;c.splice?(b=c,c=d,d=null):b=a}return c=c||function(){},"function"==typeof d&&(d=e,e=f),e?m(a,b,c,d):setTimeout(function(){m(a,b,c,d)},4),n},n.config=function(a){return n(a)},d._defined=q,f=function(a,c,d){c.splice||(d=c,c=[]),b(q,a)||b(r,a)||(r[a]=[a,c,d])},f.amd={jQuery:!0}}(),f("../node_modules/almond/almond",function(){}),function(){var a,b,c,d,e,g,h,i,j,k,l,m,n,o,p;c=Math.floor,k=Math.min,b=function(a,b){return b>a?-1:a>b?1:0},j=function(a,d,e,f,g){var h;if(null==e&&(e=0),null==g&&(g=b),0>e)throw new Error("lo must be non-negative");for(null==f&&(f=a.length);f>e;)h=c((e+f)/2),g(d,a[h])<0?f=h:e=h+1;return[].splice.apply(a,[e,e-e].concat(d)),d},g=function(a,c,d){return null==d&&(d=b),a.push(c),o(a,0,a.length-1,d)},e=function(a,c){var d,e;return null==c&&(c=b),d=a.pop(),a.length?(e=a[0],a[0]=d,p(a,0,c)):e=d,e},i=function(a,c,d){var e;return null==d&&(d=b),e=a[0],a[0]=c,p(a,0,d),e},h=function(a,c,d){var e;return null==d&&(d=b),a.length&&d(a[0],c)<0&&(e=[a[0],c],c=e[0],a[0]=e[1],p(a,0,d)),c},d=function(a,d){var e,f,g,h,i,j;for(null==d&&(d=b),h=function(){j=[];for(var b=0,d=c(a.length/2);d>=0?d>b:b>d;d>=0?b++:b--)j.push(b);return j}.apply(this).reverse(),i=[],f=0,g=h.length;g>f;f++)e=h[f],i.push(p(a,e,d));return i},n=function(a,c,d){var e;return null==d&&(d=b),e=a.indexOf(c),-1!==e?(o(a,0,e,d),p(a,e,d)):void 0},l=function(a,c,e){var f,g,i,j,k;if(null==e&&(e=b),g=a.slice(0,c),!g.length)return g;for(d(g,e),k=a.slice(c),i=0,j=k.length;j>i;i++)f=k[i],h(g,f,e);return g.sort(e).reverse()},m=function(a,c,f){var g,h,i,l,m,n,o,p,q,r;if(null==f&&(f=b),10*c<=a.length){if(l=a.slice(0,c).sort(f),!l.length)return l;for(i=l[l.length-1],p=a.slice(c),m=0,o=p.length;o>m;m++)g=p[m],f(g,i)<0&&(j(l,g,0,null,f),l.pop(),i=l[l.length-1]);return l}for(d(a,f),r=[],h=n=0,q=k(c,a.length);q>=0?q>n:n>q;h=q>=0?++n:--n)r.push(e(a,f));return r},o=function(a,c,d,e){var f,g,h;for(null==e&&(e=b),f=a[d];d>c&&(h=d-1>>1,g=a[h],e(f,g)<0);)a[d]=g,d=h;return a[d]=f},p=function(a,c,d){var e,f,g,h,i;for(null==d&&(d=b),f=a.length,i=c,g=a[c],e=2*c+1;f>e;)h=e+1,f>h&&!(d(a[e],a[h])<0)&&(e=h),a[c]=a[e],c=e,e=2*c+1;return a[c]=g,o(a,i,c,d)},a=function(){function a(a){this.cmp=null!=a?a:b,this.nodes=[]}return a.push=g,a.pop=e,a.replace=i,a.pushpop=h,a.heapify=d,a.updateItem=n,a.nlargest=l,a.nsmallest=m,a.prototype.push=function(a){return g(this.nodes,a,this.cmp)},a.prototype.pop=function(){return e(this.nodes,this.cmp)},a.prototype.peek=function(){return this.nodes[0]},a.prototype.contains=function(a){return-1!==this.nodes.indexOf(a)},a.prototype.replace=function(a){return i(this.nodes,a,this.cmp)},a.prototype.pushpop=function(a){return h(this.nodes,a,this.cmp)},a.prototype.heapify=function(){return d(this.nodes,this.cmp)},a.prototype.updateItem=function(a){return n(this.nodes,a,this.cmp)},a.prototype.clear=function(){return this.nodes=[]},a.prototype.empty=function(){return 0===this.nodes.length},a.prototype.size=function(){return this.nodes.length},a.prototype.clone=function(){var b;return b=new a,b.nodes=this.nodes.slice(0),b},a.prototype.toArray=function(){return this.nodes.slice(0)},a.prototype.insert=a.prototype.push,a.prototype.top=a.prototype.peek,a.prototype.front=a.prototype.peek,a.prototype.has=a.prototype.contains,a.prototype.copy=a.prototype.clone,a}(),function(a,b){return"function"==typeof f&&f.amd?f("heap",[],b):"object"==typeof exports?module.exports=b():a.Heap=b()}(this,function(){return a})}.call(this),f("util/constants",["require","exports","module"],function(){return{ADD_CELL:1,MOD_CELL:2,DATA:"data",FIELDS:"fields",SCALES:"scales",SIGNAL:"signal",SIGNALS:"signals",GROUP:"group",ENTER:"enter",UPDATE:"update",EXIT:"exit",SENTINEL:{sentinel:1},ADD:"add",REMOVE:"remove",TOGGLE:"toggle",CLEAR:"clear",LINEAR:"linear",ORDINAL:"ordinal",LOG:"log",POWER:"pow",TIME:"time",QUANTILE:"quantile",DOMAIN:"domain",RANGE:"range",MARK:"mark",AXIS:"axis",COUNT:"count",MIN:"min",MAX:"max",ASC:"asc",DESC:"desc"}}),f("dataflow/changeset",["require","exports","module","../util/constants"],function(a){function b(a,b){var c={};return e(a,c),c.add=[],c.mod=[],c.rem=[],c.reflow=b,c}function c(a){a._prev=void 0===a._prev?void 0:f.SENTINEL}function d(a){for(i=0,len=a.add.length;i<len;++i)c(a.add[i]);for(i=0,len=a.mod.length;i<len;++i)c(a.mod[i])}function e(a,b){b.stamp=a?a.stamp:0,b.sort=a?a.sort:null,b.facet=a?a.facet:null,b.trans=a?a.trans:null,g.forEach(function(c){b[c]=a?a[c]:{}})}var f=a("../util/constants"),g=[f.DATA,f.FIELDS,f.SCALES,f.SIGNALS];return{create:b,copy:e,finalize:d}}),f("util/config",["require","exports","module","d3"],function(a){var b=a("d3"),c={};return c.debug=!1,c.silent=!1,c.isNode="undefined"==typeof window,c.domainWhiteList=!1,c.safeMode=!1,c.baseURL="",c.svgNamespace='version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"',c.autopadInset=5,c.scale={time:b.time.scale,utc:b.time.scale.utc},c.render={lineWidth:1,lineCap:"butt",font:"sans-serif",fontSize:11},c.axis={orient:"bottom",ticks:10,padding:3,axisColor:"#000",gridColor:"#d8d8d8",tickColor:"#000",tickLabelColor:"#000",axisWidth:1,tickWidth:1,tickSize:6,tickLabelFontSize:11,tickLabelFont:"sans-serif",titleColor:"#000",titleFont:"sans-serif",titleFontSize:11,titleFontWeight:"bold",titleOffset:35},c.legend={orient:"right",offset:10,padding:3,gradientStrokeColor:"#888",gradientStrokeWidth:1,gradientHeight:16,gradientWidth:100,labelColor:"#000",labelFontSize:10,labelFont:"sans-serif",labelAlign:"left",labelBaseline:"middle",labelOffset:8,symbolShape:"circle",symbolSize:50,symbolColor:"#888",symbolStrokeWidth:1,titleColor:"#000",titleFont:"sans-serif",titleFontSize:11,titleFontWeight:"bold"},c.color={rgb:[128,128,128],lab:[50,0,0],hcl:[0,0,50],hsl:[0,0,.5]},c.range={category10:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],category20:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"],shapes:["circle","cross","diamond","square","triangle-down","triangle-up"]},c}),f("util/index",["require","exports","module","./config","heap"],function(a){function b(a){return a.replace(h,"$1\\'")}function c(a,b,c){var d=0,e=a.split(i);return a=c?(e=e.reverse()).filter(function(a){return d+=a.length,b>=d}).reverse():e.filter(function(a){return d+=a.length,b>=d}),a.length?a.join("").trim():e[0].slice(0,b)}function d(a){console.log(a)}var e=a("./config"),f={},g=Object.prototype.toString;f.isObject=function(a){return a===Object(a)},f.isFunction=function(a){return"[object Function]"==g.call(a)},f.isString=function(a){return"[object String]"==g.call(a)},f.isArray=Array.isArray||function(a){return"[object Array]"==g.call(a)},f.isNumber=function(a){return"[object Number]"==g.call(a)},f.isBoolean=function(a){return"[object Boolean]"==g.call(a)},f.isTree=function(a){return a&&a.__vgtree__},f.tree=function(a,b){var c=[a];return c.__vgtree__=!0,c.children=b||"children",c},f.number=function(a){return+a},f["boolean"]=function(a){return!!a},f.identity=function(a){return a},f["true"]=function(){return!0},f.extend=function(a){for(var b,c,d=1,e=arguments.length;e>d;++d){b=arguments[d];for(c in b)a[c]=b[c]}return a},f.duplicate=function(a){return JSON.parse(JSON.stringify(a))},f.equal=function(a,b){return JSON.stringify(a)==JSON.stringify(b)},f.field=function(a){return a.split("\\.").map(function(a){return a.split(".")}).reduce(function(a,b){return a.length&&(a[a.length-1]+="."+b.shift()),a.push.apply(a,b),a},[])},f.accessor=function(a){var b;return f.isFunction(a)||null==a?a:f.isString(a)&&(b=f.field(a)).length>1?function(a){return b.reduce(function(a,b){return a[b]},a)}:function(b){return b[a]}},f.comparator=function(a){var b=[];return void 0===a&&(a=[]),a=f.array(a).map(function(a){var c=1;return"-"===a[0]?(c=-1,a=a.slice(1)):"+"===a[0]&&(c=1,a=a.slice(1)),b.push(c),f.accessor(a)}),function(c,d){var e,f,g,h,i;for(e=0,f=a.length;f>e;++e){if(g=a[e],h=g(c),i=g(d),i>h)return-1*b[e];if(h>i)return b[e]}return 0}},f.cmp=function(a,b){return b>a?-1:a>b?1:0},f.numcmp=function(a,b){return a-b},f.array=function(a){return null!=a?f.isArray(a)?a:[a]:[]},f.values=function(a){return f.isObject(a)&&!f.isArray(a)&&a.values?f.isFunction(a.values)?a.values():a.values:a},f.tuple_ids=function(a){return a.reduce(function(a,b){return a[b._id]=1,a},{})},f.str=function(a){return f.isArray(a)?"["+a.map(f.str)+"]":f.isObject(a)?JSON.stringify(a):f.isString(a)?"'"+b(a)+"'":a};var h=/(^|[^\\])'/g;f.keys=function(a){var b=[];for(var c in a)b.push(c);return b},f.unique=function(a,b,c){if(!f.isArray(a)||0==a.length)return[];b=b||f.identity,c=c||[];for(var d,e=0,g=a.length;g>e;++e)d=b(a[e]),c.indexOf(d)<0&&c.push(d);return c},f.minIndex=function(a,b){if(!f.isArray(a)||0==a.length)return-1;b=b||f.identity;for(var c=0,d=b(a[0]),e=d,g=1,h=a.length;h>g;++g)e=b(a[g]),d>e&&(d=e,c=g);return c},f.maxIndex=function(a,b){if(!f.isArray(a)||0==a.length)return-1;b=b||f.identity;for(var c=0,d=b(a[0]),e=d,g=1,h=a.length;h>g;++g)e=b(a[g]),e>d&&(d=e,c=g);return c},f.truncate=function(a,b,d,e,f){var g=a.length;if(b>=g)return a;f=f||"...";var h=Math.max(0,b-f.length);switch(d){case"left":return f+(e?c(a,h,1):a.slice(g-h));case"middle":case"center":var i=Math.ceil(h/2),j=Math.floor(h/2);return(e?c(a,i):a.slice(0,i))+f+(e?c(a,j,1):a.slice(g-j));default:return(e?c(a,h):a.slice(0,h))+f}};var i=/([\u0009\u000A\u000B\u000C\u000D\u0020\u00A0\u1680\u180E\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u2028\u2029\u3000\uFEFF])/;f.fontString=function(a){return(a.fontStyle?a.fontStyle+" ":"")+(a.fontVariant?a.fontVariant+" ":"")+(a.fontWeight?a.fontWeight+" ":"")+(null!=a.fontSize?a.fontSize:e.render.fontSize)+"px "+(a.font||e.render.font)},f.log=function(a){e.silent||d("[Vega Log] "+a)},f.error=function(a){e.silent||(a="[Vega Err] "+a,d(a),"undefined"!=typeof alert&&alert(a))};var j;return f.debug=function(a,b){if(e.debug){var c=Function.prototype.bind.call(console.log,console);b.unshift(a.stamp||-1),b.unshift(Date.now()-j),a.add&&b.push(a.add.length,a.mod.length,a.rem.length,!!a.reflow),c.apply(console,b),j=Date.now()}},f.Heap=a("heap"),f}),f("dataflow/tuple",["require","exports","module","../util/index","../util/constants"],function(a){function b(a,b){return a=g.isObject(a)?a:{data:a},a._id=i++,a._prev=void 0!==b?b||h.SENTINEL:void 0,a}function c(a,c){return b(Object.create(a),c)}function d(a,b,c){var d=a[b];d!==c&&(e(a,b),a[b]=c)}function e(a,b){void 0!==a._prev&&(a._prev=a._prev===h.SENTINEL?{}:a._prev,a._prev[b]=a[b])}function f(){i=1}var g=a("../util/index"),h=a("../util/constants"),i=1;return{ingest:b,derive:c,set:d,prev:e,reset:f}}),f("dataflow/Node",["require","exports","module","../util/index","../util/constants"],function(a){function b(a){return a&&this.init(a),this}var c=a("../util/index"),d=a("../util/constants"),e=[d.DATA,d.FIELDS,d.SCALES,d.SIGNALS],f=1,g=b.prototype;return g.init=function(a){return this._id=f++,this._graph=a,this._rank=++a._rank,this._stamp=0,this._listeners=[],this._registered={},this._deps={data:[],fields:[],scales:[],signals:[]},this._isRouter=!1,this._isCollector=!1,this._revises=!1,this},g.clone=function(){var a=new b(this._graph);return a.evaluate=this.evaluate,a._deps=this._deps,a._isRouter=this._isRouter,a._isCollector=this._isCollector,a},g.rank=function(){return this._rank},g.last=function(a){return arguments.length?(this._stamp=a,this):this._stamp},g.dependency=function(a,b){var d=this._deps[a];if(1===arguments.length)return d;if(null===b)for(;d.length>0;)d.pop();else!c.isArray(b)&&d.indexOf(b)<0?d.push(b):d.push.apply(d,c.array(b));return this},g.router=function(a){return arguments.length?(this._isRouter=!!a,this):this._isRouter},g.collector=function(a){return arguments.length?(this._isCollector=!!a,this):this._isCollector},g.revises=function(a){return arguments.length?(this._revises=!!a,this):this._revises},g.listeners=function(){return this._listeners},g.addListener=function(a){if(!(a instanceof b))throw"Listener is not a Node";if(this._registered[a._id])return this;if(this._listeners.push(a),this._registered[a._id]=1,this._rank>a._rank)for(var c=[a];c.length;){var d=c.splice(0,1)[0];d._rank=++this._graph._rank,c.push.apply(c,d._listeners)}return this},g.removeListener=function(a){for(var b=!1,c=0,d=this._listeners.length;d>c&&!b;c++)this._listeners[c]===a&&(this._listeners.splice(c,1),this._registered[a._id]=null,b=!0);return b},g.disconnect=function(){this._listeners=[],this._registered={}},g.evaluate=function(a){return a},g.reevaluate=function(a){var b=this,c=!1;return e.some(function(d){return c=c||b._deps[d].some(function(b){return!!a[d][b]})})},b}),f("dataflow/Collector",["require","exports","module","./Node","./changeset","../util/index","../util/constants"],function(a){function b(a){return c.prototype.init.call(this,a),this._data=[],this.router(!0).collector(!0)}var c=a("./Node"),d=a("./changeset"),e=a("../util/index"),f=(a("../util/constants"),b.prototype=new c);return f.data=function(){return this._data},f.evaluate=function(a){if(e.debug(a,["collecting"]),a.reflow)return a=d.create(a),a.mod=this._data.slice(),a;if(a.rem.length){var b=a.rem.reduce(function(a,b){return a[b._id]=1,a},{});this._data=this._data.filter(function(a){return 1!==b[a._id]})}return a.add.length&&(this._data=this._data.length?this._data.concat(a.add):a.add),a.sort&&this._data.sort(a.sort),a},b}),f("dataflow/Datasource",["require","exports","module","./changeset","./tuple","./Node","./Collector","../util/index","../util/constants"],function(a){function b(a,b,c){this._graph=a,this._name=b,this._data=[],this._source=null,this._facet=c,this._input=d.create(),this._output=null,this._pipeline=null,this._collector=null,this._revises=!1}function c(a){void 0===a._prev&&(a._prev=i.SENTINEL)}var d=a("./changeset"),e=a("./tuple"),f=a("./Node"),g=a("./Collector"),h=a("../util/index"),i=a("../util/constants"),j=b.prototype;return j.name=function(a){return arguments.length?(this._name=a,this):this._name},j.source=function(a){return arguments.length?this._source=this._graph.data(a):this._source},j.add=function(a){var b=this._revises?null:void 0;return this._input.add=this._input.add.concat(h.array(a).map(function(a){return e.ingest(a,b)})),this},j.remove=function(a){var b=this._data.filter(a);return this._input.rem=this._input.rem.concat(b),this},j.update=function(a,b,c){{var d=this._input.mod,f=h.tuple_ids(d);this._revises?null:void 0}return this._input.fields[b]=1,this._data.filter(a).forEach(function(a){var g=a[b],h=c(a);g!==h&&(e.set(a,b,h),1!==f[a._id]&&(d.push(a),f[a._id]=1))}),this},j.values=function(a){return arguments.length?(this._input.rem=this._data.slice(),a&&this.add(a),this):this._collector?this._collector.data():this._data},j.revises=function(a){return arguments.length?(!this._revises&&a&&(this._data.forEach(c),this._input.add.forEach(c)),this._revises=this._revises||a,this):this._revises},j.last=function(){return this._output},j.fire=function(a){a&&(this._input=a),this._graph.propagate(this._input,this._pipeline[0])},j.pipeline=function(a){var b=this;if(!arguments.length)return this._pipeline;a.length&&(b._collector=new g(this._graph),a.push(b._collector),b._revises=a.some(function(a){return a.revises()}));var c=new f(this._graph).router(!0).collector(!0);c.evaluate=function(a){h.debug(a,["input",b._name]);var c,e=b._input,f=d.create(a);return h.keys(e.fields).forEach(function(a){f.fields[a]=1}),a.reflow?f.mod=b._data.slice():(e.rem.length&&(c=h.tuple_ids(e.rem),b._data=b._data.filter(function(a){return 1!==c[a._id]})),e.add.length&&(b._data=b._data.concat(e.add)),b._input=d.create(),f.add=e.add,f.mod=e.mod,f.rem=e.rem),f.facet=b._facet,f},a.unshift(c);var e=new f(this._graph).router(!0).collector(!0);return e.evaluate=function(a){h.debug(a,["output",b._name]);var c=d.create(a,!0);return b._facet&&(b._facet.values=b.values(),a.facet=null),b._output=a,c.data[b._name]=1,c},a.push(e),this._pipeline=a,this._graph.connect(b._pipeline),this},j.listener=function(){var a=new f(this._graph).router(!0),b=this,c=this._revises?null:void 0;return a.evaluate=function(a){b._srcMap=b._srcMap||{};var f=b._srcMap,g=d.create(a);return g.add=a.add.map(function(a){return f[a._id]=e.derive(a,void 0!==a._prev?a._prev:c)}),g.mod=a.mod.map(function(a){return f[a._id]}),g.rem=a.rem.map(function(a){var b=f[a._id];return f[a._id]=null,b}),b._input=g},a.addListener(this._pipeline[0]),a},j.addListener=function(a){return a instanceof b?this._collector?this._collector.addListener(a.listener()):this._pipeline[0].addListener(a.listener()):this._pipeline[this._pipeline.length-1].addListener(a),this},j.removeListener=function(a){this._pipeline[this._pipeline.length-1].removeListener(a)},b}),f("dataflow/Signal",["require","exports","module","./Node","./changeset","../util/index"],function(a){function b(a,b,d){return c.prototype.init.call(this,a),this._name=b,this._value=d,this}var c=a("./Node"),d=a("./changeset"),e=(a("../util/index"),b.prototype=new c);return e.name=function(){return this._name},e.value=function(a){return arguments.length?(this._value=a,this):this._value},e.fire=function(a){a||(a=d.create(null,!0)),a.signals[this._name]=1,this._graph.propagate(a,this)},b}),f("dataflow/Graph",["require","exports","module","heap","./Datasource","./Signal","./changeset","../util/index","../util/constants"],function(a){function b(){this._stamp=0,this._rank=0,this._data={},this._signals={},this.doNotPropagate={}}function c(a){var b=this;return h.isArray(a)?a.map(function(a){b._signals[a]}):this._signals[a]}function d(a,b){var c,d,e,f;for(e=0,f=a.length;f>e;++e)c=a[e],c.collector()&&(d=c),b(c,d,e)}var e=a("heap"),f=a("./Datasource"),g=a("./Signal"),h=(a("./changeset"),a("../util/index")),i=a("../util/constants"),j=b.prototype;j.data=function(a,b,c){return 1===arguments.length?this._data[a]:this._data[a]=new f(this,a,c).pipeline(b)},j.signal=function(a,b){return 1===arguments.length?c.call(this,a):this._signals[a]=new g(this,a,b)},j.signalValues=function(a){var b=this;return h.isArray(a)?a.reduce(function(a,c){return a[c]=b._signals[c].value(),a},{}):this._signals[a].value()},j.signalRef=function(a){h.isArray(a)||(a=h.field(a));var b=this.signal(a.shift()).value();if(a.length>0){var c=Function("s","return s["+a.map(h.str).join("][")+"]");b=c.call(null,b)}return b};var k=function(a,b){return a.rank==b.rank?a.pulse.reflow?1:-1:a.rank-b.rank};return j.propagate=function(a,b){var c,d,f,g,i,j,l,m,n=new e(k);if(a.stamp)throw"Pulse already has a non-zero stamp";for(a.stamp=++this._stamp,n.push({node:b,pulse:a,rank:b.rank()});n.size()>0;)if(c=n.pop(),f=c.node,g=c.pulse,i=c.rank,d=f._listeners,m=g.reflow&&f.last()>=g.stamp,!m)if(i==f.rank()){if(g=this.evaluate(g,f),g!==this.doNotPropagate)for(j=0,l=d.length;l>j;j++)n.push({node:d[j],pulse:g,rank:d[j]._rank})}else h.debug(g,["Rank mismatch",i,f.rank()]),n.push({node:f,pulse:g,rank:f.rank()})},j.connect=function(a){h.debug({},["connecting"]);var b=this;return d(a,function(c,d,e){var f=c.dependency(i.DATA),g=c.dependency(i.SIGNALS);f.length>0&&f.forEach(function(a){b.data(a).revises(c.revises()).addListener(d)}),g.length>0&&g.forEach(function(a){b.signal(a).addListener(d)}),e>0&&a[e-1].addListener(a[e])}),a},j.disconnect=function(a){h.debug({},["disconnecting"]);var b=this;return d(a,function(a,c){var d=a.dependency(i.DATA),e=a.dependency(i.SIGNALS);d.length>0&&d.forEach(function(a){b.data(a).removeListener(c)}),e.length>0&&e.forEach(function(a){b.signal(a).removeListener(c)}),a.disconnect()}),a},j.reevaluate=function(a,b){var c=!a.reflow||a.reflow&&b.last()>=a.stamp,d=!!a.add.length||!!a.rem.length||b.router();return d=d||!c,d||b.reevaluate(a)},j.evaluate=function(a,b){return this.reevaluate(a,b)?(a=b.evaluate(a),b.last(a.stamp),a):a},b}),f("scene/Encoder",["require","exports","module","../dataflow/Node","../util/index","../util/constants"],function(a){function b(a,b){var c=b.def.properties||{},e=c.update;return d.prototype.init.call(this,a.graph),this._model=a,this._mark=b,e&&(this.dependency(f.DATA,e.data),this.dependency(f.SCALES,e.scales),this.dependency(f.SIGNALS,e.signals)),this}function c(a,b,c){var d=this._model,e=a.encode,f=this._graph.signalValues(a.signals||[]),g=(a.data||[]).reduce(function(a,b){return a[b]=d.data(b).values(),a},{});e.call(e,b,b.mark.group||b,c,g,f,d.predicates())}var d=a("../dataflow/Node"),e=a("../util/index"),f=a("../util/constants"),g={},h=b.prototype=new d;return h.evaluate=function(a){e.debug(a,["encoding",this._mark.def.type]);var b,d,h,i=(this._mark.items,this._mark.def.properties||{}),j=i.enter,k=i.update,l=i.exit;for(b=0,d=a.rem.length;d>b;++b)h=a.rem[b],k&&c.call(this,k,h,a.trans),l&&c.call(this,l,h,a.trans),a.trans&&!l?a.trans.interpolate(h,g):a.trans||h.remove();for(b=0,d=a.add.length;d>b;++b)h=a.add[b],j&&c.call(this,j,h,a.trans),k&&c.call(this,k,h,a.trans),h.status=f.UPDATE;if(k)for(b=0,d=a.mod.length;d>b;++b)h=a.mod[b],c.call(this,k,h,a.trans);return a},b}),f("core/Bounds",["require","exports","module"],function(){var a=function(a){this.clear(),a&&this.union(a)},b=a.prototype;return b.clear=function(){return this.x1=+Number.MAX_VALUE,this.y1=+Number.MAX_VALUE,this.x2=-Number.MAX_VALUE,this.y2=-Number.MAX_VALUE,this},b.set=function(a,b,c,d){return this.x1=a,this.y1=b,this.x2=c,this.y2=d,this},b.add=function(a,b){return a<this.x1&&(this.x1=a),b<this.y1&&(this.y1=b),a>this.x2&&(this.x2=a),b>this.y2&&(this.y2=b),this},b.expand=function(a){return this.x1-=a,this.y1-=a,this.x2+=a,this.y2+=a,this},b.round=function(){return this.x1=Math.floor(this.x1),this.y1=Math.floor(this.y1),this.x2=Math.ceil(this.x2),this.y2=Math.ceil(this.y2),this},b.translate=function(a,b){return this.x1+=a,this.x2+=a,this.y1+=b,this.y2+=b,this},b.rotate=function(a,b,c){var d=Math.cos(a),e=Math.sin(a),f=b-b*d+c*e,g=c-b*e-c*d,h=this.x1,i=this.x2,j=this.y1,k=this.y2;return this.clear().add(d*h-e*j+f,e*h+d*j+g).add(d*h-e*k+f,e*h+d*k+g).add(d*i-e*j+f,e*i+d*j+g).add(d*i-e*k+f,e*i+d*k+g)},b.union=function(a){return a.x1<this.x1&&(this.x1=a.x1),a.y1<this.y1&&(this.y1=a.y1),a.x2>this.x2&&(this.x2=a.x2),a.y2>this.y2&&(this.y2=a.y2),this},b.encloses=function(a){return a&&this.x1<=a.x1&&this.x2>=a.x2&&this.y1<=a.y1&&this.y2>=a.y2},b.intersects=function(a){return a&&!(this.x2<a.x1||this.x1>a.x2||this.y2<a.y1||this.y1>a.y2)},b.contains=function(a,b){return!(a<this.x1||a>this.x2||b<this.y1||b>this.y2)},b.width=function(){return this.x2-this.x1},b.height=function(){return this.y2-this.y1},a}),f("render/canvas/path",["require","exports","module","d3","../../core/Bounds"],function(a){function b(a){var b,c,d,e=[];a=a.slice().replace(o[0],"###$1").split(o[1]).slice(1);for(var f,g,h=0,i=a.length;i>h;h++){b=a[h],c=b.slice(1).trim().replace(o[2],"$1###-").split(o[3]),g=[b.charAt(0)];for(var f=0,j=c.length;j>f;f++)d=parseFloat(c[f]),isNaN(d)||g.push(d);var k=g[0].toLowerCase(),l=n[k];if(g.length-1>l)for(var m=1,p=g.length;p>m;m+=l)e.push([g[0]].concat(g.slice(m,m+l)));else e.push(g)}return e}function c(a,b,c,d,g,h,i){for(var j=d[0],k=d[1],l=d[2],m=d[3],n=d[4],o=d[5],p=d[6],q=e(o,p,j,k,m,n,l,b,c),r=0;r<q.length;r++){var s=f.apply(null,q[r]);a.bezierCurveTo.apply(a,s),g.add(s[0]-h,s[1]-i),g.add(s[2]-h,s[3]-i),g.add(s[4]-h,s[5]-i)}}function d(a,b,c,d){for(var g=c[0],h=c[1],i=c[2],j=c[3],k=c[4],l=c[5],m=c[6],n=e(l,m,g,h,j,k,i,a,b),o=0;o<n.length;o++){var p=f.apply(null,n[o]);d.add(p[0],p[1]),d.add(p[2],p[3]),d.add(p[4],p[5])}}function e(a,b,c,d,e,f,g,h,i){if(k=r.call(arguments),p[k])return p[k];var j=g*(Math.PI/180),l=Math.sin(j),m=Math.cos(j);c=Math.abs(c),d=Math.abs(d);var n=m*(h-a)*.5+l*(i-b)*.5,o=m*(i-b)*.5-l*(h-a)*.5,q=n*n/(c*c)+o*o/(d*d);q>1&&(q=Math.sqrt(q),c*=q,d*=q);var s=m/c,t=l/c,u=-l/d,v=m/d,w=s*h+t*i,x=u*h+v*i,y=s*a+t*b,z=u*a+v*b,A=(y-w)*(y-w)+(z-x)*(z-x),B=1/A-.25;0>B&&(B=0);var C=Math.sqrt(B);f==e&&(C=-C);var D=.5*(w+y)-C*(z-x),E=.5*(x+z)+C*(y-w),F=Math.atan2(x-E,w-D),G=Math.atan2(z-E,y-D),H=G-F;0>H&&1==f?H+=2*Math.PI:H>0&&0==f&&(H-=2*Math.PI);for(var I=Math.ceil(Math.abs(H/(.5*Math.PI+.001))),J=[],K=0;I>K;K++){var L=F+K*H/I,M=F+(K+1)*H/I;J[K]=[D,E,L,M,c,d,l,m]}return p[k]=J}function f(a,b,c,d,e,f,g,h){if(k=r.call(arguments),q[k])return q[k];var i=h*e,j=-g*f,l=g*e,m=h*f,n=Math.cos(c),o=Math.sin(c),p=Math.cos(d),s=Math.sin(d),t=.5*(d-c),u=Math.sin(.5*t),v=8/3*u*u/Math.sin(t),w=a+n-v*o,x=b+o+v*n,y=a+p,z=b+s,A=y+v*s,B=z-v*p;return q[k]=[i*w+j*x,l*w+m*x,i*A+j*B,l*A+m*B,i*y+j*z,l*y+m*z]}function g(a,b,d,e){var f,g,h,i,j,k=null,l=0,n=0,o=0,p=0,q=new m;void 0==d&&(d=0),void 0==e&&(e=0),a.beginPath();for(var r=0,s=b.length;s>r;++r){switch(f=b[r],f[0]){case"l":l+=f[1],n+=f[2],a.lineTo(l+d,n+e),q.add(l,n);break;case"L":l=f[1],n=f[2],a.lineTo(l+d,n+e),q.add(l,n);break;case"h":l+=f[1],a.lineTo(l+d,n+e),q.add(l,n);break;case"H":l=f[1],a.lineTo(l+d,n+e),q.add(l,n);break;case"v":n+=f[1],a.lineTo(l+d,n+e),q.add(l,n);break;case"V":n=f[1],a.lineTo(l+d,n+e),q.add(l,n);break;case"m":l+=f[1],n+=f[2],a.moveTo(l+d,n+e),q.add(l,n);break;case"M":l=f[1],n=f[2],a.moveTo(l+d,n+e),q.add(l,n);break;case"c":g=l+f[5],h=n+f[6],o=l+f[3],p=n+f[4],a.bezierCurveTo(l+f[1]+d,n+f[2]+e,o+d,p+e,g+d,h+e),q.add(l+f[1],n+f[2]),q.add(o,p),q.add(g,h),l=g,n=h;break;case"C":l=f[5],n=f[6],o=f[3],p=f[4],a.bezierCurveTo(f[1]+d,f[2]+e,o+d,p+e,l+d,n+e),q.add(f[1],f[2]),q.add(o,p),q.add(l,n);break;case"s":g=l+f[3],h=n+f[4],o=2*l-o,p=2*n-p,a.bezierCurveTo(o+d,p+e,l+f[1]+d,n+f[2]+e,g+d,h+e),q.add(o,p),q.add(l+f[1],n+f[2]),q.add(g,h),o=l+f[1],p=n+f[2],l=g,n=h;break;case"S":g=f[3],h=f[4],o=2*l-o,p=2*n-p,a.bezierCurveTo(o+d,p+e,f[1]+d,f[2]+e,g+d,h+e),l=g,n=h,q.add(f[1],f[2]),q.add(o,p),q.add(g,h),o=f[1],p=f[2];break;case"q":g=l+f[3],h=n+f[4],o=l+f[1],p=n+f[2],a.quadraticCurveTo(o+d,p+e,g+d,h+e),l=g,n=h,q.add(o,p),q.add(g,h);break;case"Q":g=f[3],h=f[4],a.quadraticCurveTo(f[1]+d,f[2]+e,g+d,h+e),l=g,n=h,o=f[1],p=f[2],q.add(o,p),q.add(g,h);break;case"t":g=l+f[1],h=n+f[2],null===k[0].match(/[QqTt]/)?(o=l,p=n):"t"===k[0]?(o=2*l-i,p=2*n-j):"q"===k[0]&&(o=2*l-o,p=2*n-p),i=o,j=p,a.quadraticCurveTo(o+d,p+e,g+d,h+e),l=g,n=h,o=l+f[1],p=n+f[2],q.add(o,p),q.add(g,h);break;case"T":g=f[1],h=f[2],o=2*l-o,p=2*n-p,a.quadraticCurveTo(o+d,p+e,g+d,h+e),l=g,n=h,q.add(o,p),q.add(g,h);break;case"a":c(a,l+d,n+e,[f[1],f[2],f[3],f[4],f[5],f[6]+l+d,f[7]+n+e],q,d,e),l+=f[6],n+=f[7];break;case"A":c(a,l+d,n+e,[f[1],f[2],f[3],f[4],f[5],f[6]+d,f[7]+e],q,d,e),l=f[6],n=f[7];break;case"z":case"Z":a.closePath()}k=f}return q.translate(d,e)}function h(a,b){for(var c,e,f,g,h,i=null,j=0,k=0,l=0,m=0,n=0,o=a.length;o>n;++n){switch(c=a[n],c[0]){case"l":j+=c[1],k+=c[2],b.add(j,k);break;case"L":j=c[1],k=c[2],b.add(j,k);break;case"h":j+=c[1],b.add(j,k);break;case"H":j=c[1],b.add(j,k);break;case"v":k+=c[1],b.add(j,k);break;case"V":k=c[1],b.add(j,k);break;case"m":j+=c[1],k+=c[2],b.add(j,k);break;case"M":j=c[1],k=c[2],b.add(j,k);break;case"c":e=j+c[5],f=k+c[6],l=j+c[3],m=k+c[4],b.add(j+c[1],k+c[2]),b.add(l,m),b.add(e,f),j=e,k=f;break;case"C":j=c[5],k=c[6],l=c[3],m=c[4],b.add(c[1],c[2]),b.add(l,m),b.add(j,k);break;case"s":e=j+c[3],f=k+c[4],l=2*j-l,m=2*k-m,b.add(l,m),b.add(j+c[1],k+c[2]),b.add(e,f),l=j+c[1],m=k+c[2],j=e,k=f;break;case"S":e=c[3],f=c[4],l=2*j-l,m=2*k-m,j=e,k=f,b.add(c[1],c[2]),b.add(l,m),b.add(e,f),l=c[1],m=c[2];break;case"q":e=j+c[3],f=k+c[4],l=j+c[1],m=k+c[2],j=e,k=f,b.add(l,m),b.add(e,f);break;case"Q":e=c[3],f=c[4],j=e,k=f,l=c[1],m=c[2],b.add(l,m),b.add(e,f);break;case"t":e=j+c[1],f=k+c[2],null===i[0].match(/[QqTt]/)?(l=j,m=k):"t"===i[0]?(l=2*j-g,m=2*k-h):"q"===i[0]&&(l=2*j-l,m=2*k-m),g=l,h=m,j=e,k=f,l=j+c[1],m=k+c[2],b.add(l,m),b.add(e,f);break;case"T":e=c[1],f=c[2],l=2*j-l,m=2*k-m,j=e,k=f,b.add(l,m),b.add(e,f);break;case"a":d(j,k,[c[1],c[2],c[3],c[4],c[5],c[6]+j,c[7]+k],b),j+=c[6],k+=c[7];break;case"A":d(j,k,[c[1],c[2],c[3],c[4],c[5],c[6],c[7]],b),j=c[6],k=c[7];break;case"z":case"Z":}i=c}return b}function i(a){var b=a[0],c=l.svg.area().x(function(a){return a.x}).y1(function(a){return a.y}).y0(function(a){return a.y+a.height});return b.interpolate&&c.interpolate(b.interpolate),null!=b.tension&&c.tension(b.tension),c(a)}function j(a){var b=a[0],c=l.svg.line().x(function(a){return a.x}).y(function(a){return a.y});return b.interpolate&&c.interpolate(b.interpolate),null!=b.tension&&c.tension(b.tension),c(a)}var k,l=a("d3"),m=a("../../core/Bounds"),n={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},o=[/([MLHVCSQTAZmlhvcsqtaz])/g,/###/,/(\d)-/g,/\s|,|###/],p={},q={},r=Array.prototype.join;return{parse:b,render:g,bounds:h,area:i,line:j}}),f("util/bounds",["require","exports","module","d3","../core/Bounds","../render/canvas/path","./index","./config"],function(a){function b(){if(B)return B;if(t.isNode){var b="canvas";return B=new(a(b))(1,1).getContext("2d")}return B=p.select("body").append("canvas").attr("class","vega_hidden").attr("width",1).attr("height",1).style("display","none").node().getContext("2d")}function c(a,b,c){return null==b?c.set(0,0,0,0):(v(b,c),a.stroke&&0!==a.opacity&&a.strokeWidth>0&&c.expand(a.strokeWidth)),c}function d(a,b){var d=a.path?a.pathCache||(a.pathCache=u(a.path)):null;return c(a,d,b)}function e(a,b){var d=a.mark.items,a=d[0],e=a.pathCache||(a.pathCache=u(w(d)));return c(d[0],e,b)}function f(a,b){var d=a.mark.items,a=d[0],e=a.pathCache||(a.pathCache=u(x(d)));return c(d[0],e,b)}function g(a,b){var c=a.x||0,d=a.y||0,e=c+a.width||0,f=d+a.height||0;
return b.set(c,d,e,f),a.stroke&&0!==a.opacity&&a.strokeWidth>0&&b.expand(a.strokeWidth),b}function h(a,b){var c=a.width||0,d=a.height||0,e=(a.x||0)-("center"===a.align?c/2:"right"===a.align?c:0),f=(a.y||0)-("middle"===a.baseline?d/2:"bottom"===a.baseline?d:0);return b.set(e,f,e+c,f+d)}function i(a,b){var c,d;return b.set(c=a.x||0,d=a.y||0,null!=a.x2?a.x2:c,null!=a.y2?a.y2:d),a.stroke&&0!==a.opacity&&a.strokeWidth>0&&b.expand(a.strokeWidth),b}function j(a,b){var c,d,e,f,g,h,i,j,k,l=a.x||0,m=a.y||0,n=a.innerRadius||0,o=a.outerRadius||0,p=(a.startAngle||0)-y,q=(a.endAngle||0)-y,r=1/0,s=-1/0,t=1/0,u=-1/0,v=[p,q],w=p-p%y;for(d=0;4>d&&q>w;++d,w+=y)v.push(w);for(d=0,e=v.length;e>d;++d)c=v[d],f=Math.cos(c),h=n*f,j=o*f,g=Math.sin(c),i=n*g,k=o*g,r=Math.min(r,h,j),s=Math.max(s,h,j),t=Math.min(t,i,k),u=Math.max(u,i,k);return b.set(l+r,m+t,l+s,m+u),a.stroke&&0!==a.opacity&&a.strokeWidth>0&&b.expand(a.strokeWidth),b}function k(a,b){var c,d,e,f,g=null!=a.size?a.size:100,h=a.x||0,i=a.y||0;switch(a.shape){case"cross":c=Math.sqrt(g/5)/2,d=3*c,b.set(h-d,i-c,h+d,i+c);break;case"diamond":f=Math.sqrt(g/(2*A)),e=f*A,b.set(h-e,i-f,h+e,i+f);break;case"square":d=Math.sqrt(g),c=d/2,b.set(h-c,i-c,h+c,i+c);break;case"triangle-down":e=Math.sqrt(g/z),f=e*z/2,b.set(h-e,i-f,h+e,i+f);break;case"triangle-up":e=Math.sqrt(g/z),f=e*z/2,b.set(h-e,i-f,h+e,i+f);break;default:c=Math.sqrt(g/Math.PI),b.set(h-c,i-c,h+c,i+c)}return a.stroke&&0!==a.opacity&&a.strokeWidth>0&&b.expand(a.strokeWidth),b}function l(a,c,d){var e,f,g=(a.x||0)+(a.dx||0),h=(a.y||0)+(a.dy||0),i=a.fontSize||t.render.fontSize,j=a.align,k=a.baseline,l=a.radius||0,m=b();return m.font=s.fontString(a),m.textAlign=j||"left",m.textBaseline=k||"alphabetic",e=m.measureText(a.text||"").width,l&&(f=(a.theta||0)-Math.PI/2,g+=l*Math.cos(f),h+=l*Math.sin(f)),"center"===j?g-=e/2:"right"===j&&(g-=e),"top"===k?h+=i/5:"bottom"===k?h-=i:"middle"===k?h=h-i/2+i/10:h-=4*i/5,c.set(g,h,g+e,h+i),a.angle&&!d&&c.rotate(a.angle*Math.PI/180,a.x||0,a.y||0),c.expand(d?0:1)}function m(a,b,c){var d,e,f=a.axisItems||[],g=a.legendItems||[];for(d=0,e=f.length;e>d;++d)b.union(f[d].bounds);for(d=0,e=a.items.length;e>d;++d)b.union(a.items[d].bounds);if(c){for(d=0,e=g.length;e>d;++d)b.union(g[d].bounds);null!=a.width&&null!=a.height&&b.add(a.width,a.height),null!=a.x&&null!=a.y&&b.add(0,0)}return b.translate(a.x||0,a.y||0),b}function n(a,b,c){b=b||C[a.mark.marktype],a.bounds_prev||(a["bounds:prev"]=new q);var d=a.bounds,e=a["bounds:prev"];return d&&e.clear().union(d),a.bounds=b(a,d?d.clear():new q,c),d||e.clear().union(a.bounds),a.bounds}function o(a,b,c){b=b||a.bounds&&a.bounds.clear()||new q;var d,e,f=a.marktype,g=C[f],h=a.items;if("area"===f||"line"===f)h.length&&(h[0].bounds=g(h[0],b));else if(g)for(d=0,e=h.length;e>d;++d)b.union(n(h[d],g,c));a.bounds=b}var p=a("d3"),q=a("../core/Bounds"),r=a("../render/canvas/path"),s=a("./index"),t=a("./config"),u=r.parse,v=r.bounds,w=r.area,x=r.line,y=Math.PI/2,z=Math.sqrt(3),A=Math.tan(30*Math.PI/180),B=null,C={group:m,symbol:k,image:h,rect:g,rule:i,arc:j,text:l,path:d,area:e,line:f};return{mark:o,item:n,text:l,group:m}}),f("scene/Bounder",["require","exports","module","../dataflow/Node","../util/bounds","../util/constants","../util/index"],function(a){function b(a,b){return this._mark=b,c.prototype.init.call(this,a.graph).router(!0)}var c=a("../dataflow/Node"),d=a("../util/bounds"),e=a("../util/constants"),f=a("../util/index"),g=b.prototype=new c;return g.evaluate=function(a){return f.debug(a,["bounds",this._mark.marktype]),d.mark(this._mark),this._mark.marktype===e.GROUP&&d.mark(this._mark,null,!1),a.reflow=!0,a},b}),f("scene/Item",["require","exports","module"],function(){function a(a){this.mark=a}var b=a.prototype;return b.hasPropertySet=function(a){var b=this.mark.def.properties;return b&&null!=b[a]},b.cousin=function(a,b){if(0===a)return this;a=a||-1;var c=this.mark,d=c.group,e=null==b?c.items.indexOf(this):b,f=d.items.indexOf(c)+a;return d.items[f].items[e]},b.sibling=function(a){if(0===a)return this;a=a||-1;var b=this.mark,c=b.items.indexOf(this)+a;return b.items[c]},b.remove=function(){var a=this,b=a.mark.items,c=b.indexOf(a);return c>=0&&(c===b.length-1?b.pop():b.splice(c,1)),a},b.touch=function(){this.pathCache&&(this.pathCache=null),this.mark.pathCache&&(this.mark.pathCache=null)},a}),f("parse/expr",["require","exports","module","../util/index"],function(a){function b(a,b){var g,h,i,j,k,l,m,n=b.split(f),o={},p={};for(k=0,l=0,i=0,j=n.length;j>i;++i){var g=n[i];"'"!==g?'"'!==g?l||k||(d[g]&&(n[i]=d[g]),e[g]&&(h=n[i+1])&&"("===h[0]&&(n[i]=e[g]),":"==n[i+1]&&(m=g+":"+n[i+2],a.signal((m=c.field(m))[0])&&(o[m[0]]=1,h=c.field(n[i+2]),n[i]="sg['"+n[i],n[i+2]=n[i+2].replace(h[0],h[0]+"']"),i+=2)),a.signal((h=c.field(g))[0])&&(o[h[0]]=1,n[i]=n[i].replace(h[0],"sg["+c.str(h[0])+"]")),"d"==h[0]&&(h=h.splice(1),p[h[0]]=1,h.length>1&&(p[h.join(".")]=1))):k||(l=!l):l||(k=!k)}return{fn:Function("d","e","i","p","sg","return ("+n.join("")+");"),signals:c.keys(o),fields:c.keys(p)}}var c=a("../util/index"),d={E:"Math.E",LN2:"Math.LN2",LN10:"Math.LN10",LOG2E:"Math.LOG2E",LOG10E:"Math.LOG10E",PI:"Math.PI",SQRT1_2:"Math.SQRT1_2",SQRT2:"Math.SQRT2"},e={abs:"Math.abs",acos:"Math.acos",asin:"Math.asin",atan:"Math.atan",atan2:"Math.atan2",ceil:"Math.ceil",cos:"Math.cos",exp:"Math.exp",floor:"Math.floor",log:"Math.log",max:"Math.max",min:"Math.min",pow:"Math.pow",random:"Math.random",round:"Math.round",sin:"Math.sin",sqrt:"Math.sqrt",tan:"Math.tan",date:"Date.parse"},f=/([\"\']|[\=\<\>\~\&\|\?\:\+\-\/\*\%\!\^\,\;\[\]\{\}\(\) ]+)/;return b.eval=function(a,b,d,e,f,g,h){return h=a.signalValues(c.array(h)),b.call(null,d,e,f,g,h)},b}),f("transforms/Parameter",["require","exports","module","../parse/expr","../util/index","../util/constants"],function(a){function b(a,b){this._name=a,this._type=b,this._value=[],this._accessors=[],this._resolution=!1,this._signals={}}var c=a("../parse/expr"),d=a("../util/index"),e=a("../util/constants"),f=/array/i,g=/data/i,h=/field/i,i=/expr/i,j=b.prototype;return j._get=function(){var a=f.test(this._type),b=g.test(this._type),c=h.test(this._type);return b?a?{names:this._value,sources:this._accessors}:{name:this._value[0],source:this._accessors[0]}:c?a?{fields:this._value,accessors:this._accessors}:{field:this._value[0],accessor:this._accessors[0]}:a?this._value:this._value[0]},j.get=function(a){var b,c,e,f=g.test(this._type),i=h.test(this._type);if(!this._resolution)return this._get();if(f)return this._accessors=this._value.map(function(b){return a.data(b)}),this._get();for(b in this._signals)c=this._signals[b],e=a.signalRef(b),i&&(this._accessors[c]=this._value[c]!=e?d.accessor(e):this._accessors[c]),this._value[c]=e;return this._get()},j.set=function(a,b){var f=this,j=i.test(this._type),k=g.test(this._type),l=h.test(this._type);return this._value=d.array(b).map(function(b,g){if(d.isString(b)){if(j){var h=c(a._graph,b);return a.dependency(e.FIELDS,h.fields),a.dependency(e.SIGNALS,h.signals),h.fn}return l?(f._accessors[g]=d.accessor(b),a.dependency(e.FIELDS,b)):k&&(f._resolution=!0,a.dependency(e.DATA,b)),b}return void 0!==b.value?b.value:void 0!==b.field?(f._accessors[g]=d.accessor(b.field),a.dependency(e.FIELDS,b.field),b.field):void 0!==b.signal?(f._resolution=!0,f._signals[b.signal]=g,a.dependency(e.SIGNALS,b.signal),b.signal):b}),a},b}),f("transforms/Transform",["require","exports","module","../dataflow/Node","./Parameter","../util/index","../util/constants"],function(a){function b(a){return a&&c.prototype.init.call(this,a),this}var c=a("../dataflow/Node"),d=a("./Parameter"),e=(a("../util/index"),a("../util/constants"));b.addParameters=function(a,b){var c;for(var e in b)c=b[e],a[e]=new d(e,c.type),c["default"]&&a[e].set(a,c["default"]);a._parameters=b};var f=b.prototype=new c;return f.clone=function(){var a=c.prototype.clone.call(this);a.transform=this.transform,a._parameters=this._parameters;for(var b in this)a[b]||(a[b]=this[b]);return a},f.transform=function(a){return a},f.evaluate=function(a){var b=this._stamp<a.stamp&&this.dependency(e.SIGNALS).some(function(b){return!!a.signals[b]});return this.transform(a,b)},f.output=function(a){for(var b in this._output)void 0!==a[b]&&(this._output[b]=a[b]);return this},b}),f("util/bins",["require","exports","module"],function(){function a(a,b){for(var c=0,d=a.length;d>c;){var e=c+d>>>1;a[e]<b?c=e+1:d=e}return c}function b(b){b=b||{};var c,d,e,f,g=b.maxbins||1024,h=b.base||10,i=b.div||[5,2],j=b.minstep||0,k=Math.log(h),l=Math.ceil(Math.log(g)/k),m=b.min,n=b.max,o=n-m,p=Math.max(j,Math.pow(h,Math.round(Math.log(o)/k)-l)),q=Math.ceil(o/p);if(null!=b.step)p=b.step;else if(b.steps)e=a(b.steps,o/g),e===b.steps.length&&--e,p=b.steps[e];else{do p*=h,q=Math.ceil(o/p);while(q>g);for(e=0;e<i.length;++e)d=p/i[e],d>=j&&g>=o/d&&(p=d,q=Math.ceil(o/p))}return d=Math.log(p),c=d>=0?0:~~(-d/k)+1,f=(0>m?-1:1)*Math.pow(h,-c-1),m=Math.min(m,Math.floor(m/p+f)*p),n=Math.ceil(n/p)*p,{start:m,stop:n,step:p,unit:c}}return b}),f("transforms/Bin",["require","exports","module","./Transform","../util/index","../util/bins","../dataflow/tuple"],function(a){function b(a){return c.prototype.init.call(this,a),c.addParameters(this,{on:{type:"field"},min:{type:"value"},max:{type:"value"},step:{type:"value"},maxbins:{type:"value","default":20}}),this._output={bin:"bin"},this}var c=a("./Transform"),d=(a("../util/index"),a("../util/bins")),e=a("../dataflow/tuple"),f=b.prototype=new c;return f.transform=function(a){function b(b){var d=c.on.get().accessor(b);d=null==d?null:g.start+g.step*~~((d-g.start)/g.step),e.set(b,f,d,a.stamp)}var c=this,f=this._output.bin,g=d({min:this.min.get(),max:this.max.get(),step:this.step.get(),maxbins:this.maxbins.get()});return a.add.forEach(b),a.mod.forEach(b),a.rem.forEach(b),a},b}),f("transforms/Cross",["require","exports","module","./Transform","../dataflow/Collector","../util/index","../dataflow/tuple","../dataflow/changeset"],function(a){function b(a){return h.prototype.init.call(this,a),h.addParameters(this,{"with":{type:"data"},diagonal:{type:"value","default":"true"}}),this._output={left:"a",right:"b"},this._collector=new i(a),this._lastRem=null,this._lastWith=null,this._ids={},this._cache={},this.router(!0)}function c(a,b){var c=this._cache[a._id]=this._cache[a._id]||{c:[],s:this._stamp};c.c.push(b)}function d(a,b,d,e,f){for(var g,h,i,j=b?d:this._collector.data(),l=0,m=j.length,n=void 0!==f._prev?null:void 0;m>l;++l)h=j[l],i=b?f._id+"_"+h._id:h._id+"_"+f._id,this._ids[i]||(f._id!=h._id||e)&&(g=k.ingest({},n),g[this._output.left]=b?f:h,g[this._output.right]=b?h:f,a.add.push(g),c.call(this,f,g),c.call(this,h,g),this._ids[i]=1)}function e(a,b,c){var d=this,e=this._cache[c._id];this._lastRem>e.s&&(e.c=e.c.filter(function(a){var c=a[d._output[b?"right":"left"]];return null!==d._cache[c._id]}),e.s=this._lastRem),a.mod.push.apply(a.mod,e.c)}function f(a,b){a.rem.push.apply(a.rem,this._cache[b._id].c),this._cache[b._id]=null,this._lastRem=this._stamp}function g(a,b){(a.add.length||a.rem.length)&&(b.fields[this._output.left]=1,b.fields[this._output.right]=1)}var h=a("./Transform"),i=a("../dataflow/Collector"),j=a("../util/index"),k=a("../dataflow/tuple"),l=a("../dataflow/changeset"),m=b.prototype=new h;return m.transform=function(a){j.debug(a,["crossing"]),this._collector.evaluate(a);var b=this["with"].get(this._graph),c=this.diagonal.get(this._graph),h=!b.name,i=this._collector.data(),k=h?a:b.source.last(),m=h?i:b.source.values(),n=l.create(a),o=f.bind(this,n);return a.rem.forEach(o),a.add.forEach(d.bind(this,n,!0,m,c)),!h&&k.stamp>this._lastWith&&(k.rem.forEach(o),k.add.forEach(d.bind(this,n,!1,i,c)),k.mod.forEach(e.bind(this,n,!1)),g.call(this,k,n),this._lastWith=k.stamp),a.mod.forEach(e.bind(this,n,!0)),g.call(this,a,n),n},b}),f("transforms/Aggregate",["require","exports","module","./Transform","../dataflow/tuple","../dataflow/changeset","../util/index","../util/constants"],function(a){function b(a){return a&&this.init(a),this}var c=a("./Transform"),d=a("../dataflow/tuple"),e=a("../dataflow/changeset"),f=(a("../util/index"),a("../util/constants")),g=b.prototype=new c;return g.init=function(a){return this._refs=[],this._cells={},c.prototype.init.call(this,a).router(!0).revises(!0)},g.data=function(){return this._cells},g._reset=function(a,b){var c,d;for(c in this._cells)(d=this._cells[c])&&b.rem.push(d.tpl);this._cells={}},g._keys=function(a){var b,c=this._refs.reduce(function(c,d){return void 0!==(b=d(a))?(c.push(b),c):c},[]),d=c.join("|");return c.length>0?{keys:c,key:d}:void 0},g._cell=function(a){var b=this._keys(a);return this._cells[b.key]||(this._cells[b.key]=this._new_cell(a,b))},g._new_cell=function(a,b){return{cnt:0,tpl:this._new_tuple(a,b),flg:f.ADD_CELL}},g._new_tuple=function(){return d.derive(null,null)},g._add=function(a){var b=this._cell(a);return b.cnt+=1,b.flg|=f.MOD_CELL,b},g._rem=function(a){var b=this._cell(a);return b.cnt-=1,b.flg|=f.MOD_CELL,b},g._mod=function(a,b){return a._prev&&a._prev!==f.SENTINEL&&void 0!==this._keys(a._prev)?(this._rem(a._prev),this._add(a)):b?this._add(a):this._cell(a)},g.transform=function(a,b){var c,d,g,h,i=this,j=e.create(a);b&&this._reset(a,j),a.add.forEach(function(a){i._add(a)}),a.mod.forEach(function(a){i._mod(a,b)}),a.rem.forEach(function(a){i._rem(a._prev&&a._prev!==f.SENTINEL&&void 0!==i._keys(a._prev)?a._prev:a)});for(c in this._cells)d=this._cells[c],d&&(g=d.flg,h=d.tpl,0===d.cnt?(g===f.MOD_CELL&&j.rem.push(h),this._cells[c]=null):g&f.ADD_CELL?j.add.push(h):g&f.MOD_CELL&&j.mod.push(h),d.flg=0);return j},b}),f("transforms/Facet",["require","exports","module","./Transform","./Aggregate","../dataflow/tuple","../dataflow/changeset","../util/index","../util/constants"],function(a){function b(a){return d.prototype.init.call(this,a),c.addParameters(this,{keys:{type:"array<field>"}}),this._pipeline=[],this}var c=a("./Transform"),d=a("./Aggregate"),e=a("../dataflow/tuple"),f=a("../dataflow/changeset"),g=a("../util/index"),h=a("../util/constants"),i=b.prototype=new d;return i.pipeline=function(a){return arguments.length?(this._pipeline=a,this):this._pipeline},i._reset=function(a,b){var c,d;for(c in this._cells)d=this._cells[c],d&&(b.rem.push(d.tpl),d["delete"]());this._cells={}},i._new_tuple=function(a,b){return e.ingest(b,null)},i._new_cell=function(a,b){var c=d.prototype._new_cell.call(this,a,b),e=this._pipeline.map(function(a){return a.clone()}),f=this,h=c.tpl;return c.ds=this._graph.data("vg_"+h._id,e,h),c["delete"]=function(){g.debug({},["deleting cell",b.key]),f.removeListener(e[0]),f._graph.disconnect(e)},this.addListener(e[0]),c},i._add=function(a){var b=d.prototype._add.call(this,a);return b.ds._input.add.push(a),b},i._mod=function(a,b){var c=d.prototype._mod.call(this,a,b);return c.flg&h.ADD_CELL||c.ds._input.mod.push(a),c.flg|=h.MOD_CELL,c},i._rem=function(a){var b=d.prototype._rem.call(this,a);return b.ds._input.rem.push(a),b},i.transform=function(a,b){g.debug(a,["faceting"]),this._refs=this.keys.get(this._graph).accessors;var c,e,h=d.prototype.transform.call(this,a,b);for(c in this._cells)e=this._cells[c],null!=e&&(0===e.cnt?e["delete"]():f.copy(a,e.ds._input));return h},b}),f("transforms/Filter",["require","exports","module","./Transform","../dataflow/changeset","../parse/expr","../util/index","../util/constants"],function(a){function b(a){return d.prototype.init.call(this,a),d.addParameters(this,{test:{type:"expr"}}),this._skip={},this}function c(a){return f.eval(this._graph,this.test.get(this._graph),a,null,null,null,this.dependency(h.SIGNALS))}var d=a("./Transform"),e=a("../dataflow/changeset"),f=a("../parse/expr"),g=a("../util/index"),h=a("../util/constants"),i=b.prototype=new d;return i.transform=function(a){g.debug(a,["filtering"]);var b=e.create(a),d=this._skip,f=this;return a.rem.forEach(function(a){1!==d[a._id]?b.rem.push(a):d[a._id]=0}),a.add.forEach(function(a){c.call(f,a)?b.add.push(a):d[a._id]=1}),a.mod.forEach(function(a){var e=c.call(f,a),g=1===d[a._id];e&&g?(d[a._id]=0,b.add.push(a)):e&&!g?b.mod.push(a):!e&&g||(b.rem.push(a),d[a._id]=1)}),b},b}),f("transforms/Fold",["require","exports","module","./Transform","../util/index","../dataflow/tuple","../dataflow/changeset"],function(a){function b(a){return f.prototype.init.call(this,a),f.addParameters(this,{on:{type:"array<field>"}}),this._output={key:"key",value:"value"},this._cache={},this.router(!0).revises(!0)}function c(a,b){for(var c in this._cache)b.rem.push.apply(b.rem,this._cache[c]);this._cache={}}function d(a,b,c){var d=this._cache[a._id]||(this._cache[a._id]=Array(c));return d[b]||(d[b]=h.derive(a,a._prev))}function e(a,b,c,e){for(var f,g,i,j=0,k=a.length,l=b.length;k>j;++j)for(g=a[j],f=0;l>f;++f)i=d.call(this,g,f,l),h.set(i,this._output.key,b[f]),h.set(i,this._output.value,c[f](g)),e.push(i)}var f=a("./Transform"),g=a("../util/index"),h=a("../dataflow/tuple"),i=a("../dataflow/changeset"),j=b.prototype=new f;return j.transform=function(a,b){g.debug(a,["folding"]);var d=this,f=this.on.get(this._graph),h=f.fields,j=f.accessors,k=i.create(a);return b&&c.call(this,a,k),e.call(this,a.add,h,j,k.add,a.stamp),e.call(this,a.mod,h,j,b?k.add:k.mod,a.stamp),a.rem.forEach(function(a){k.rem.push.apply(k.rem,d._cache[a._id]),d._cache[a._id]=null}),(a.add.length||a.rem.length||h.some(function(b){return!!a.fields[b]}))&&(k.fields[this._output.key]=1,k.fields[this._output.value]=1),k},b}),f("transforms/Formula",["require","exports","module","./Transform","../dataflow/tuple","../parse/expr","../util/index","../util/constants"],function(a){function b(a){return d.prototype.init.call(this,a),d.addParameters(this,{field:{type:"value"},expr:{type:"expr"}}),this}function c(a,b){var c=f.eval(this._graph,this.expr.get(this._graph),a,null,null,null,this.dependency(h.SIGNALS));e.set(a,b,c)}var d=a("./Transform"),e=a("../dataflow/tuple"),f=a("../parse/expr"),g=a("../util/index"),h=a("../util/constants"),i=b.prototype=new d;return i.transform=function(a){g.debug(a,["formulating"]);var b=this,d=this.field.get(this._graph);return a.add.forEach(function(e){c.call(b,e,d,a.stamp)}),this.reevaluate(a)&&a.mod.forEach(function(e){c.call(b,e,d,a.stamp)}),a.fields[d]=1,a},b}),f("transforms/Sort",["require","exports","module","./Transform","../parse/expr","../util/index"],function(a){function b(a){return c.prototype.init.call(this,a),c.addParameters(this,{by:{type:"array<field>"}}),this.router(!0)}var c=a("./Transform"),d=(a("../parse/expr"),a("../util/index")),e=b.prototype=new c;return e.transform=function(a){return d.debug(a,["sorting"]),(a.add.length||a.mod.length||a.rem.length)&&(a.sort=d.comparator(this.by.get(this._graph).fields)),a},b}),f("util/quickselect",["require","exports","module","./index"],function(a){var b=a("./index");return function(a,c,d){function e(a,b){var d=c[a];c[a]=c[b],c[b]=d}null===c&&(c=[],b.keys(d).forEach(function(a){var b=0,e=d[a];for(a=+a||a;e>b;++b)c.push(a)}));for(var f,g,h,i=0,j=c.length-1;j>i;){for(h=c[a],e(a,j),g=f=i;j>g;++g)c[g]<h&&e(g,f++);if(e(j,f),f===a)break;a>f?i=f+1:j=f-1}return c[a]}}),f("transforms/measures",["require","exports","module","../dataflow/tuple","../util/index","../util/quickselect","../util/constants"],function(a){function b(a){return function(b){var c=Object.create(a);return c.out=b||a.name,c.idx||(c.idx=0),c}}function c(a){function b(a,c){return(c.req||[]).forEach(function(c){a[c]||b(a,a[c]=j[c]())}),a}var c=a.reduce(b,a.reduce(function(a,b){return a[b.name]=b,a},{})),d=[];for(var e in c)d.push(c[e]);return d.sort(function(a,b){return a.idx-b.idx}),d}function d(a){var b=c(a),d="this.flg = this.ADD; this.tpl = t;",j="",k="",l="var t = this.tpl;";return b.forEach(function(a){d+=a.init,j+=a.add,k+=a.rem}),a.forEach(function(a){l+="this.tuple.set(t,'"+a.out+"',"+a.set+");"}),j+="this.flg |= this.MOD;",k+="this.flg |= this.MOD;",l+="return t;",d=Function("t",d),d.prototype.ADD=i.ADD_CELL,d.prototype.MOD=i.MOD_CELL,d.prototype.add=Function("v",j),d.prototype.rem=Function("v",k),d.prototype.set=Function("stamp",l),d.prototype.mod=e,d.prototype.keys=g.keys,d.prototype.sel=h,d.prototype.tuple=f,d}function e(a,b){void 0!==b&&b!==a&&(this.rem(b),this.add(a))}var f=a("../dataflow/tuple"),g=a("../util/index"),h=a("../util/quickselect"),i=a("../util/constants"),j={count:b({name:"count",init:"this.cnt = 0;",add:"this.cnt += 1;",rem:"this.cnt -= 1;",set:"this.cnt"}),_counts:b({name:"_counts",init:"this.cnts = {};",add:"this.cnts[v] = ++this.cnts[v] || 1;",rem:"this.cnts[v] = --this.cnts[v] < 0 ? 0 : this.cnts[v];",set:"",req:["count"]}),sum:b({name:"sum",init:"this.sum = 0;",add:"this.sum += v;",rem:"this.sum -= v;",set:"this.sum"}),avg:b({name:"avg",init:"this.avg = 0;",add:"var d = v - this.avg; this.avg += d / this.cnt;",rem:"var d = v - this.avg; this.avg -= d / this.cnt;",set:"this.avg",req:["count"],idx:1}),"var":b({name:"var",init:"this.dev = 0;",add:"this.dev += d * (v - this.avg);",rem:"this.dev -= d * (v - this.avg);",set:"this.dev / (this.cnt-1)",req:["avg"],idx:2}),varp:b({name:"varp",init:"",add:"",rem:"",set:"this.dev / this.cnt",req:["var"],idx:3}),stdev:b({name:"stdev",init:"",add:"",rem:"",set:"Math.sqrt(this.dev / (this.cnt-1))",req:["var"],idx:4}),stdevp:b({name:"stdevp",init:"",add:"",rem:"",set:"Math.sqrt(this.dev / this.cnt)",req:["var"],idx:5}),min:b({name:"min",init:"this.min = +Infinity;",add:"this.min = v < this.min ? v : this.min;",rem:"var self = this; this.min = v == this.min ? this.keys(this.cnts).reduce(function(m, v) {    return self.cnts[(v = +v)] > 0 && v < m ? v : m }, +Infinity) : this.min;",set:"this.min",req:["_counts"],idx:6}),max:b({name:"max",init:"this.max = -Infinity;",add:"this.max = v > this.max ? v : this.max;",rem:"var self = this; this.max = v == this.max ? this.keys(this.cnts).reduce(function(m, v) {    return self.cnts[(v = +v)] > 0 && v > m ? v : m }, -Infinity) : this.max;",set:"this.max",req:["_counts"],idx:7}),median:b({name:"median",init:"this.vals = []; ",add:"if(this.vals) this.vals.push(v); ",rem:"this.vals = null;",set:"this.cnt % 2 ? this.sel(~~(this.cnt/2), this.vals, this.cnts) : 0.5 * (this.sel(~~(this.cnt/2)-1, this.vals, this.cnts) + this.sel(~~(this.cnt/2), this.vals, this.cnts))",req:["_counts"],idx:8})};return j.create=d,j}),f("transforms/Stats",["require","exports","module","./Transform","./Aggregate","../dataflow/tuple","../dataflow/changeset","./measures","../util/index","../util/constants"],function(a){function b(a){return d.prototype.init.call(this,a),c.addParameters(this,{group_by:{type:"array<field>"},on:{type:"field"}}),this._output={count:"count",avg:"avg",min:"min",max:"max",sum:"sum",mean:"mean","var":"var",stdev:"stdev",varp:"varp",stdevp:"stdevp",median:"median"},this._Measures=null,this.__facet=null,this}var c=a("./Transform"),d=a("./Aggregate"),e=a("../dataflow/tuple"),f=(a("../dataflow/changeset"),a("./measures")),g=a("../util/index"),h=a("../util/constants"),i=b.prototype=new d;return i.measures={set:function(a,b){return b.indexOf(h.COUNT)<0&&b.push(h.COUNT),a._Measures=f.create(b.map(function(b){return f[b](a._output[b])})),a}},i._reset=function(a,b){var c,d;for(c in this._cells)(d=this._cells[c])&&(a.facet||b.rem.push(d.set()));this._cells={}},i._keys=function(a){return this.__facet?this.__facet:this._refs.length?d.prototype._keys.call(this,a):{keys:[],key:""}},i._new_cell=function(a){var b,c,d=this.group_by.get(this._graph),f=d.fields,g=d.accessors,h=this.__facet||{};if(!this.__facet){for(b=0,c=f.length;c>b;++b)h[f[b]]=g[b](a);h=e.ingest(h,null)}return new this._Measures(h)},i._add=function(a){var b=this.on.get(this._graph).accessor;this._cell(a).add(b(a))},i._rem=function(a){var b=this.on.get(this._graph).accessor;this._cell(a).rem(b(a))},i.transform=function(a,b){g.debug(a,["stats"]),a.facet?this.__facet=a.facet:this._refs=this.group_by.get(this._graph).accessors;var c,e,f=d.prototype.transform.call(this,a,b);if(a.facet)return this._cells[a.facet.key].set(),a;for(c in this._cells)e=this._cells[c],e&&e.set();return f},b}),f("transforms/Unique",["require","exports","module","./Transform","./Aggregate","../dataflow/tuple","../util/index"],function(a){function b(a){return d.prototype.init.call(this,a),c.addParameters(this,{on:{type:"field"},as:{type:"value"}}),this}var c=a("./Transform"),d=a("./Aggregate"),e=a("../dataflow/tuple"),f=a("../util/index"),g=b.prototype=new d;return g._new_tuple=function(a){var b={},c=this.on.get(this._graph),d=this.as.get(this._graph);return b[d]=c.accessor(a),e.ingest(b,null)},g.transform=function(a,b){return f.debug(a,["uniques"]),this._refs=[this.on.get(this._graph).accessor],d.prototype.transform.call(this,a,b)},b}),f("transforms/Zip",["require","exports","module","./Transform","../dataflow/Collector","../util/index"],function(a){function b(a){return d.prototype.init.call(this,a),d.addParameters(this,{"with":{type:"data"},as:{type:"value"},key:{type:"field","default":"data"},withKey:{type:"field","default":null},"default":{type:"value"}}),this._map={},this._collector=new e(a),this._lastJoin=0,this.revises(!0)}function c(a){return this._map[a]||(this._map[a]=[])}var d=a("./Transform"),e=a("../dataflow/Collector"),f=a("../util/index"),g=b.prototype=new d;return g.transform=function(a){var b=this["with"].get(this._graph),d=b.source,e=d.last(),g=d.values(),h=this.key.get(this._graph),i=this.withKey.get(this._graph),j=this.as.get(this._graph),k=this["default"].get(this._graph),l=c.bind(this),m={};if(f.debug(a,["zipping",b.name]),i.field)e&&e.stamp>this._lastJoin&&(e.rem.forEach(function(a){var b=l(i.accessor(a));b[0]&&b[0].forEach(function(a){a[j]=k}),b[1]=null}),e.add.forEach(function(a){var b=l(i.accessor(a));b[0]&&b[0].forEach(function(b){b[j]=a}),b[1]=a}),e.fields[i.field]&&e.mod.forEach(function(a){var b;if(a._prev&&void 0!==(b=i.accessor(a._prev))){var c=l(b);c[0]&&c[0].forEach(function(a){a[j]=k}),c[1]=null;var d=l(i.accessor(a));d[0]&&d[0].forEach(function(b){b[j]=a}),d[1]=a}}),this._lastJoin=e.stamp),a.add.forEach(function(a){var b=l(h.accessor(a));a[j]=b[1]||k,(b[0]=b[0]||[]).push(a)}),a.rem.forEach(function(a){var b=h.accessor(a);(m[b]=m[b]||{})[a._id]=1}),a.fields[h.field]&&a.mod.forEach(function(a){var b;if(a._prev&&void 0!==(b=h.accessor(a._prev))){var c=l(h.accessor(a));a[j]=c[1]||k,(c[0]=c[0]||[]).push(a),(m[b]=m[b]||{})[a._id]=1}}),f.keys(m).forEach(function(a){var b=l(a);b[0]&&(b[0]=b[0].filter(function(b){return 1!==m[a][b._id]}))});else{if(0==a.add.length&&0==a.rem.length&&0==e.add.length&&0==e.rem.length)return a;this._collector.evaluate(a);var n,o=this._collector.data(),p=g.length;for(n=0;n<o.length;n++)o[n][j]=g[n%p]}return a.fields[j]=1,a},b}),f("transforms/index",["require","exports","module","./Bin","./Cross","./Facet","./Filter","./Fold","./Formula","./Sort","./Stats","./Unique","./Zip"],function(a){return{bin:a("./Bin"),cross:a("./Cross"),facet:a("./Facet"),filter:a("./Filter"),fold:a("./Fold"),formula:a("./Formula"),sort:a("./Sort"),stats:a("./Stats"),unique:a("./Unique"),zip:a("./Zip")}}),f("parse/transforms",["require","exports","module","../util/index","../transforms/index"],function(a){var b=a("../util/index"),c=a("../transforms/index");return function d(a,e){var f=new c[e.type](a.graph);if("facet"==e.type){var g=(e.transform||[]).map(function(b){return d(a,b)});f.pipeline(g)}return e.output&&f.output(e.output),b.keys(e).forEach(function(a){"type"!==a&&"output"!==a&&("transform"!==a||"facet"!==e.type)&&f[a].set(f,e[a])}),f}}),f("parse/modify",["require","exports","module","../dataflow/Node","../dataflow/tuple","../util/index","../util/constants"],function(a){var b=a("../dataflow/Node"),c=a("../dataflow/tuple"),d=a("../util/index"),e=a("../util/constants"),f=function(a,b,c,d){for(var e=c.length-1;e>=0;--e)c[e][a]==b&&d.push.apply(d,c.splice(e,1))};return function(a,g,h){var i=a.graph,j=g.signal?d.field(g.signal):null,k=j?j[0]:null,l=g.predicate?a.predicate(g.predicate):null,m=null===l,n=new b(i);return n.evaluate=function(b){if(null!==l){var k={};(l.data||[]).forEach(function(b){k[b]=a.data(b).values()}),m=l({},k,i.signalValues(l.signals||[]),a._predicates)}if(d.debug(b,[g.type+"ing",m]),!m)return b;var n={},o=j?i.signalRef(g.signal):null,p=a.data(h.name),q=p.revises()?null:void 0,r=null;if(n[g.field]=o,g.type==e.ADD)r=c.ingest(n,q),b.add.push(r),p._data.push(r);else if(g.type==e.REMOVE)f(g.field,o,b.add,b.rem),f(g.field,o,b.mod,b.rem),p._data=p._data.filter(function(a){return a[g.field]!==o});else if(g.type==e.TOGGLE){var s=[],t=[];f(g.field,o,b.rem,s),f(g.field,o,b.add,t),f(g.field,o,b.mod,t),0==s.length&&0==t.length&&s.push(c.ingest(n)),b.add.push.apply(b.add,s),p._data.push.apply(p._data,s),b.rem.push.apply(b.rem,t),p._data=p._data.filter(function(a){return-1===t.indexOf(a)})}else g.type==e.CLEAR&&(b.rem.push.apply(b.rem,b.add),b.rem.push.apply(b.rem,b.mod),b.add=[],b.mod=[],p._data=[]);return b.fields[g.field]=1,b},k&&n.dependency(e.SIGNALS,k),l&&n.dependency(e.SIGNALS,l.signals),n}}),f("util/load",["require","exports","module","./index","./config"],function(b){function c(a){return k.test(a)}function d(a){return 0===a.indexOf(l)}function e(b,c){return i.log("LOAD: "+b),f(b)?void a.xhr(b,function(a,b){b&&(b=b.responseText),c(a,b)}):void i.error("URL is not whitelisted: "+b)}function f(a){if(!j.domainWhiteList)return!0;var b=document.createElement("a");b.href=a;var c=b.hostname.toLowerCase();return j.domainWhiteList.some(function(a){return a===c||c.lastIndexOf("."+a)===c.length-a.length-1})}function g(a,c){i.log("LOAD FILE: "+a);var d=a.indexOf(l);d>=0&&(a=a.slice(l.length));var e="fs";b(e).readFile(a,c)}function h(a,c){i.log("LOAD HTTP: "+a);var d="http",e=b(d).request(a,function(a){var b=0,d=new Buffer(parseInt(a.headers["content-length"],10));a.on("error",function(a){c(a,null)}),a.on("data",function(a){a.copy(d,b),b+=a.length}),a.on("end",function(){c(null,d)})});e.on("error",function(a){c(a)}),e.end()}var i=b("./index"),j=b("./config"),k=/^[A-Za-z]+\:\/\//,l="file://";return function(a,b){var f=c(a)?a:j.baseURL+a;if(j.isNode){var i=d(f)?g:h;i(f,b)}else e(f,b)}}),f("util/read",["require","exports","module","./index","d3"],function(a){function c(a,b){var c=b&&b.type||"json";return a=h[c](a,b),b&&b.parse&&d(a,b.parse),a}function d(a,b){var c=f.keys(b),d=c.map(function(a){return i[b[a]]}),g=f.isTree(a);e(g?[a]:a,c,d,g)}function e(a,b,c,e){var f,g,h,i,j;for(g=0,i=a.length;i>g;++g){for(f=a[g],h=0,j=b.length;j>h;++h)f[b[h]]=c[h](f[b[h]]);e&&f.values&&d(f,b,c,!0)}}var f=a("./index"),g=a("d3"),h={},i={number:f.number,"boolean":f["boolean"],date:Date.parse};return h.json=function(a,b){var c=f.isObject(a)?a:JSON.parse(a);return b&&b.property&&(c=f.accessor(b.property)(c)),c},h.csv=function(a){var b=g.csv.parse(a);return b},h.tsv=function(a){var b=g.tsv.parse(a);return b},h.topojson=function(a,c){if(null==b)return f.error("TopoJSON library not loaded."),[];var d=f.isObject(a)?a:JSON.parse(a),e=[];return c&&c.feature?e=(e=d.objects[c.feature])?b.feature(d,e).features:(f.error("Invalid TopoJSON object: "+c.feature),[]):c&&c.mesh?e=(e=d.objects[c.mesh])?[b.mesh(d,d.objects[c.mesh])]:(f.error("Invalid TopoJSON object: "+c.mesh),[]):f.error("Missing TopoJSON feature or mesh parameter."),e},h.treejson=function(a,b){return a=f.isObject(a)?a:JSON.parse(a),f.tree(a,b.children)},c.formats=h,c.parse=d,c}),f("parse/data",["require","exports","module","./transforms","./modify","../util/index","../util/load","../util/read"],function(a){var b=a("./transforms"),c=a("./modify"),d=a("../util/index"),e=a("../util/load"),f=a("../util/read"),g=function(a,b,c){function h(b){return function(e,g){e?d.error("LOADING FAILED: "+b.url):a.data(b.name).values(f(g.toString(),b.format)),0===--i&&c()}}var i=0;return(b||[]).forEach(function(b){b.url&&(i+=1,e(b.url,h(b))),g.datasource(a,b)}),0===i&&c(),b};return g.datasource=function(a,d){var e=(d.transform||[]).map(function(c){return b(a,c)}),g=(d.modify||[]).map(function(b){return c(a,b,d)}),h=a.data(d.name,g.concat(e));return d.values?h.values(f(d.values,d.format)):d.source&&(h.source(d.source).revises(h.revises()).addListener(h),a.removeListener(h.pipeline()[0])),h},g}),f("scene/Builder",["require","exports","module","../dataflow/Node","./Encoder","./Bounder","./Item","../parse/data","../dataflow/tuple","../dataflow/changeset","../util/index","../util/constants"],function(a){function b(){return arguments.length?this.init.apply(this,arguments):this
}function c(){var a,b,c,d,e=this._def.from,f=e.mark;f?(a=["vg",this._parent_id,f].join("_"),b={name:a,transform:e.transform,modify:e.modify}):(a=["vg",this._from,this._def.type,Date.now()].join("_"),b={name:a,source:this._from,transform:e.transform,modify:e.modify}),this._from=a,this._ds=m.datasource(this._model,b);var g=this._ds.revises();if(f)c=this.sibling(f).revises(g),c._isSuper?c.addListener(this._ds.listener()):c._bounder.addListener(this._ds.listener());else{var d=this._ds.source().revises(g).last();input=o.create(d),input.add=d.add,input.mod=d.mod,input.rem=d.rem,input.stamp=null,this._graph.propagate(input,this._ds.listener())}}function d(){var a=this._revises?null:void 0,b=n.ingest(new l(this._mark),a);return this._def.width&&n.set(b,"width",this._def.width),this._def.height&&n.set(b,"height",this._def.height),b}function e(a,b,c,e,f,g){var h,i,j,k,l,m;for(h=0,j=a.length;j>h;++h)l=a[h],k=b?this._map[i=b(l)]:f[h],m=k?!1:(k=d.call(this),!0),k.status=m?q.ENTER:q.UPDATE,k.datum=l,n.set(k,"key",i),this._map[i]=k,c.push(k),m?e.add.push(k):(!g||g&&g[l._id])&&e.mod.push(k)}function f(a,b,c){var d,f,g,i,j=o.create(a),k=h(this._def.key||"_id"),l=(a.add,a.mod),m=a.rem,n=[];for(d=0,g=m.length;g>d;++d)i=this._map[f=k(m[d])],i.status=q.EXIT,n.push(i),j.rem.push(i),this._map[f]=null;return e.call(this,b,k,n,j,null,p.tuple_ids(c?b:l)),this._mark.items=n,j}function g(a,b,c){var d,f,g,i=o.create(a),j=h(this._def.key),k=this._mark.items||[],l=[];for(d=0,f=k.length;f>d;++d)g=k[d],g.status=q.EXIT,j&&(this._map[g.key]=g);for(e.call(this,b,j,l,i,k,c?p.tuple_ids(b):null),d=0,f=k.length;f>d;++d)g=k[d],g.status===q.EXIT&&(n.set(g,"key",j?g.key:this._items.length),l.splice(0,0,g),i.rem.push(g));return this._mark.items=l,i}function h(a){if(null==a)return null;var b=p.array(a).map(p.accessor);return function(a){for(var c="",d=0,e=b.length;e>d;++d)d>0&&(c+="|"),c+=String(b[d](a));return c}}var i=a("../dataflow/Node"),j=a("./Encoder"),k=a("./Bounder"),l=a("./Item"),m=a("../parse/data"),n=a("../dataflow/tuple"),o=a("../dataflow/changeset"),p=a("../util/index"),q=a("../util/constants"),r=b.prototype=new i;return r.init=function(a,b,d,e,f,g){return i.prototype.init.call(this,a.graph).router(!0).collector(!0),this._model=a,this._def=b,this._mark=d,this._from=(b.from?b.from.data:null)||g,this._ds=p.isString(this._from)?a.data(this._from):null,this._map={},this._revises=!1,d.def=b,d.marktype=b.type,d.interactive=!(b.interactive===!1),d.items=[],this._parent=e,this._parent_id=f,b.from&&(b.from.mark||b.from.transform||b.from.modify)&&c.call(this),this._isSuper=this._def.type!==q.GROUP,this._encoder=new j(this._model,this._mark),this._bounder=new k(this._model,this._mark),this._ds&&this._encoder.dependency(q.DATA,this._from),this.dependency(q.DATA,this._encoder.dependency(q.DATA)),this.dependency(q.SCALES,this._encoder.dependency(q.SCALES)),this.dependency(q.SIGNALS,this._encoder.dependency(q.SIGNALS)),this},r.revises=function(a){return arguments.length?(!this._revises&&a&&this._items.forEach(function(a){void 0===a._prev&&(a._prev=q.SENTINEL)}),this._revises=this._revises||a,this):this._revises},r.pipeline=function(){return[this]},r.connect=function(){var a=this;return this._model.graph.connect(this.pipeline()),this._encoder.dependency(q.SCALES).forEach(function(b){a._parent.scale(b).addListener(a)}),this._parent&&(this._isSuper?this.addListener(this._parent._collector):this._bounder.addListener(this._parent._collector)),this},r.disconnect=function(){var a=this;return this._listeners.length?(i.prototype.disconnect.call(this),this._model.graph.disconnect(this.pipeline()),this._encoder.dependency(q.SCALES).forEach(function(b){a._parent.scale(b).removeListener(a)}),this):this},r.sibling=function(a){return this._parent.child(a,this._parent_id)},r.evaluate=function(a){p.debug(a,["building",this._from,this._def.type]);var b,c,d,e;return this._ds?(b=o.create(a),e=p.duplicate(b.data),delete b.data[this._ds.name()],c=this._encoder.reevaluate(b),b.data=e,c&&(b.mod=this._mark.items.slice()),d=this._ds.last(),d?d.stamp>this._stamp&&(b=f.call(this,d,this._ds.values(),c)):b.reflow=!0):(c=this._encoder.reevaluate(a),e=p.isFunction(this._def.from)?this._def.from():[q.SENTINEL],b=g.call(this,a,e,c)),b=this._graph.evaluate(b,this._encoder),this._isSuper?this._graph.evaluate(b,this._bounder):b},b}),f("scene/Scale",["require","exports","module","d3","../dataflow/Node","../transforms/Stats","../dataflow/changeset","../util/index","../util/config","../util/constants"],function(a){function b(a,b,c){return this._model=a,this._def=b,this._parent=c,this._updated=!1,l.prototype.init.call(this,a.graph)}function c(a){var b=this._def.name,c=b+":prev",g=d.call(this,a.scale(b)),h=g.type===q.ORDINAL?e:f,i=j.call(this,a);return h.call(this,g,i,a),a.scale(b,g),a.scale(c,a.scale(c)||g),g}function d(a){var b=this._def.type||q.LINEAR;if(!a||b!==a.type){var c=p.scale[b]||k.scale[b];c||o.error("Unrecognized scale type: "+b),(a=c()).type=a.type||b,a.scaleName=this._def.name,a._prev={}}return a}function e(a,b,c){var d,e,f=this._def,h=a._prev,i=!1;o.isObject(f.range)&&!o.isArray(f.range)&&(i=!0,b=g.call(this,q.RANGE,f.range,a,c)),d=g.call(this,q.DOMAIN,f.domain,a,c),d&&!o.equal(h.domain,d)&&(a.domain(d),h.domain=d,this._updated=!0),o.equal(h.range,b)||(e="string"==typeof b[0],e||b.length>2||1===b.length||i?a.range(b):f.points?a.rangePoints(b,f.padding||0):f.round||void 0===f.round?a.rangeRoundBands(b,f.padding||0):a.rangeBands(b,f.padding||0),h.range=b,this._updated=!0)}function f(a,b,c){var d,e,f=this._def,h=a._prev;d=f.type===q.QUANTILE?g.call(this,q.DOMAIN,f.domain,a,c):i.call(this,a,c),d&&!o.equal(h.domain,d)&&(a.domain(d),h.domain=d,this._updated=!0),"height"===f.range&&(b=b.reverse()),o.equal(h.range,b)||(a[f.round&&a.rangeRound?"rangeRound":"range"](b),h.range=b,this._updated=!0,this._stamp>0||(f.exponent&&f.type===q.POWER&&a.exponent(f.exponent),f.clamp&&a.clamp(!0),f.nice&&(f.type===q.TIME?(e=k.time[f.nice],e||o.error("Unrecognized interval: "+e),a.nice(e)):a.nice())))}function g(a,b,c,d){if(o.isArray(b))return b.map(h.bind(this));var e,f,g,i,j,k,l,n,p,r,s=this,t=this._graph,u=b.fields||o.array(b),v=c.type===q.ORDINAL||c.type===q.QUANTILE,w="_"+a,x=c[w],y=b.sort;for(x||(x=c[w]=new m(t),l=[],v&&y?l.push(y.stat):v||l.push(q.MIN,q.MAX),x.measures.set(x,l)),e=0,f=u.length;f>e;++e)if(j=u[e],n=j.data||"vg_"+d.datum._id,p=t.data(n).revises(!0).last(),!(p.stamp<=this._stamp)){if(k=o.array(j.field).map(function(a){return a.group?o.accessor(a.group)(d.datum):a}),v)for(x.on.set(x,y?y.field:"_id"),g=0,i=k.length;i>g;++g)x.group_by.set(x,k[g]).evaluate(p);else for(g=0,i=k.length;i>g;++g)x.on.set(x,k[g]).evaluate(p);this.dependency(q.DATA,n),x.dependency(q.SIGNALS).forEach(function(a){s.dependency(q.SIGNALS,a)})}return p=x.data(),v?(r=o.keys(p).filter(function(a){return null!=p[a]}),y&&(y=y.order.signal?t.signalRef(y.order.signal):y.order,y=(y==q.DESC?"-":"+")+"tpl."+x.on.get(t).field,y=o.comparator(y),r=r.map(function(a){return{key:a,tpl:p[a].tpl}}).sort(y).map(function(a){return a.key})),r):(p=p[""],null==p?[]:[p.tpl.min,p.tpl.max])}function h(a){var b,c=a.signal;return c?(this.dependency(q.SIGNALS,(b=o.field(c))[0]),this._graph.signalRef(b)):a}function i(a,b){var c,d=this._def,e=[null,null];return void 0!==d.domain&&(e=o.isObject(d.domain)?g.call(this,q.DOMAIN,d.domain,a,b):e),c=e.length-1,void 0!==d.domainMin&&(e[0]=o.isObject(d.domainMin)?d.domainMin.signal?h.call(this,d.domainMin):g.call(this,q.DOMAIN+q.MIN,d.domainMin,a,b)[0]:d.domainMin),void 0!==d.domainMax&&(e[c]=o.isObject(d.domainMax)?d.domainMax.signal?h.call(this,d.domainMax):g.call(this,q.DOMAIN+q.MAX,d.domainMax,a,b)[1]:d.domainMax),d.type===q.LOG||d.type===q.TIME||!d.zero&&void 0!==d.zero||(e[0]=Math.min(0,e[0]),e[c]=Math.max(0,e[c])),e}function j(a){var b=this._def,c=[null,null];if(void 0!==b.range)if("string"==typeof b.range)if(r[b.range])c=[0,a[b.range]];else{if(!p.range[b.range])return o.error("Unrecogized range: "+b.range),c;c=p.range[b.range]}else if(o.isArray(b.range))c=b.range.map(h.bind(this));else{if(o.isObject(b.range))return null;c=[0,b.range]}if(void 0!==b.rangeMin&&(c[0]=b.rangeMin.signal?h.call(this,b.rangeMin):b.rangeMin),void 0!==b.rangeMax&&(c[c.length-1]=b.rangeMax.signal?h.call(this,b.rangeMax):b.rangeMax),void 0!==b.reverse){var d=b.reverse;o.isObject(d)&&(d=o.accessor(d.field)(a.datum)),d&&(c=c.reverse())}return c}var k=a("d3"),l=a("../dataflow/Node"),m=a("../transforms/Stats"),n=a("../dataflow/changeset"),o=a("../util/index"),p=a("../util/config"),q=a("../util/constants"),r={width:1,height:1},s=b.prototype=new l;return s.evaluate=function(a){var b=this,d=function(a){c.call(b,a)};return this._updated=!1,a.add.forEach(d),a.mod.forEach(d),this._updated&&(a.scales[this._def.name]=1),n.create(a,!0)},s.dependency=function(a,b){if(2==arguments.length){b=o.array(b);for(var c=0,d=b.length;d>c;++c)this._graph[a==q.DATA?q.DATA:q.SIGNAL](b[c]).addListener(this._parent)}return l.prototype.dependency.call(this,a,b)},b}),f("parse/properties",["require","exports","module","d3","../dataflow/tuple","../util/index","../util/config"],function(a){function b(a,b,f){var j,k,l,m,n="",o=i.keys(f),p={},q={signals:{},scales:{},data:{}};for(n+="var o = trans ? {} : item;\n",j=0,k=o.length;k>j;++j)m=f[l=o[j]],n+=j>0?"\n  ":"  ",m.rule?(m=d(a,l,m.rule),n+="\n  "+m.code):(m=e(l,m),n+="this.tpl.set(o, "+i.str(l)+", "+m.val+");"),p[l]=!0,["signals","scales","data"].forEach(function(a){null!=m[a]&&i.array(m[a]).forEach(function(b){q[a][b]=1})});p.x2&&(p.x?(n+="\n  if (o.x > o.x2) { var t = o.x;this.tpl.set(o, 'x', o.x2);this.tpl.set(o, 'x2', t); };",n+="\n  this.tpl.set(o, 'width', (o.x2 - o.x));"):n+=p.width?"\n  this.tpl.set(o, 'x', (o.x2 - o.width));":"\n  this.tpl.set(o, 'x', o.x2);"),p.y2&&(p.y?(n+="\n  if (o.y > o.y2) { var t = o.y;this.tpl.set(o, 'y', o.y2);this.tpl.set(o, 'y2', t);};",n+="\n  this.tpl.set(o, 'height', (o.y2 - o.y));"):n+=p.height?"\n  this.tpl.set(o, 'y', (o.y2 - o.height));":"\n  this.tpl.set(o, 'y', o.y2);"),c(b,p)&&(n+="\n  item.touch();"),n+="\n  if (trans) trans.interpolate(item, o);";try{var r=Function("item","group","trans","db","signals","predicates",n);return r.tpl=h,r.util=i,r.d3=g,{encode:r,signals:i.keys(q.signals),scales:i.keys(q.scales),data:i.keys(q.data)}}catch(s){i.error(s),i.log(n)}}function c(a,b){return b.path||("area"===a||"line"===a)&&(b.x||b.x2||b.width||b.y||b.y2||b.height||b.tension||b.interpolate)}function d(a,b,c){var d=[],f=[],g=[],h=[],j="";return(c||[]).forEach(function(k,l){var m,n=k.predicate,o=a.predicate(n),p=[],q=b+"_arg"+l;i.keys(k.input).forEach(function(a){var b=e(l,k.input[a]);p.push(i.str(a)+": "+b.val),b.signals&&d.push.apply(d,i.array(b.signals)),b.scales&&f.push.apply(f,i.array(b.scales))}),m=e(b,k),m.signals&&d.push.apply(d,i.array(m.signals)),m.scales&&f.push.apply(f,i.array(m.scales)),o&&n?(d.push.apply(d,o.signals),g.push.apply(g,o.data),h.push(q+" = {"+p.join(", ")+"}"),j+="if(predicates["+i.str(n)+"]("+q+", db, signals, predicates)) {\n    this.tpl.set(o, "+i.str(b)+", "+m.val+");\n",j+=c[l+1]?"  } else ":"  }"):j+="{\n    this.tpl.set(o, "+i.str(b)+", "+m.val+");\n  }"}),j="var "+h.join(",\n      ")+";\n  "+j,{code:j,signals:d,scales:f,data:g}}function e(a,b){if(null==b)return null;var c="fill"===a||"stroke"===a,d=[];if(c){if(b.c)return f("hcl",b.h,b.c,b.l);if(b.h||b.s)return f("hsl",b.h,b.s,b.l);if(b.l||b.a)return f("lab",b.l,b.a,b.b);if(b.r||b.g||b.b)return f("rgb",b.r,b.g,b.b)}var e=null,g=null;if(void 0!==b.value&&(e=i.str(b.value)),void 0!==b.signal&&(g=i.field(b.signal),e="signals["+g.map(i.str).join("][")+"]",d.push(g.shift())),null!=b.group){var h="group.datum";i.isString(b.group)&&(h=k[b.group]?"group."+b.group:"group.datum["+i.field(b.group).map(i.str).join("][")+"]")}if(null!=b.field?i.isString(b.field)?(e="item.datum["+i.field(b.field).map(i.str).join("][")+"]",null!=b.group&&(e="this.util.accessor("+e+")("+h+")")):b.field.signal?(g=i.field(b.field.signal),e="item.datum[signals["+g.map(i.str).join("][")+"]]",null!=b.group&&(e="this.util.accessor("+e+")("+h+")"),d.push(g.shift())):e="this.util.accessor(group.datum["+i.field(b.field.group).map(i.str).join("][")+"])(item.datum)":null!=b.group&&(e=h),null!=b.scale){var j=null;i.isString(b.scale)?j=i.str(b.scale):b.scale.signal?(g=i.field(b.scale.signal),j="signals["+g.map(i.str).join("][")+"]",d.push(g.shift())):j=(b.scale.group?"group":"item")+".datum["+i.str(b.scale.group||b.scale.field)+"]",j="group.scale("+j+")",b.invert&&(j+=".invert"),e=null!==e||b.band||b.mult||b.offset?j+(b.band?".rangeBand()":"("+(null!==e?e:"item.datum.data")+")"):j}return e="("+(b.mult?i.number(b.mult)+" * ":"")+e+")"+(b.offset?" + "+i.number(b.offset):""),{val:e,signals:d,scales:b.scale}}function f(a,b,c,d){var f=b?e("",b):j.color[a][0],g=c?e("",c):j.color[a][1],h=d?e("",d):j.color[a][2];return signals=[],scales=[],[f,g,h].forEach(function(a){a.signals&&signals.push.apply(signals,a.signals),a.scales&&scales.push(a.scales)}),{val:"(this.d3."+a+"("+[f.val,g.val,h.val].join(",")+') + "")',signals:signals,scales:scales}}var g=a("d3"),h=a("../dataflow/tuple"),i=a("../util/index"),j=a("../util/config"),k={width:1,height:1,"mark.group.width":1,"mark.group.height":1};return b}),f("parse/mark",["require","exports","module","../util/index","./properties"],function(a){var b=a("../util/index"),c=a("./properties");return function d(a,e){var f=e.properties,g=e.marks;return b.keys(f).forEach(function(b){f[b]=c(a,e.type,f[b])}),e.delay&&(e.delay=c(a,e.type,{delay:e.delay})),g&&(e.marks=g.map(function(b){return d(a,b)})),e}}),f("scene/axis",["require","exports","module","../util/config","../dataflow/tuple","../util/index","../parse/mark"],function(b){function c(b){function c(){x.type=null}function e(a){var c,d,e;"ordinal"===a.type?(c={scale:a.scaleName,offset:.5+a.rangeBand()/2},d=c):(c={scale:a.scaleName,offset:.5},d={scale:a.scaleName+":prev",offset:.5}),e=f(a),Q.gridLines||(Q.gridLines=l()),Q.majorTicks||(Q.majorTicks=l()),Q.minorTicks||(Q.minorTicks=l()),Q.tickLabels||(Q.tickLabels=m()),Q.domain||(Q.domain=o()),Q.title||(Q.title=n()),Q.gridLines.properties.enter.stroke={value:p.axis.gridColor},h(u,Q.gridLines,d,c,1/0),h(u,Q.majorTicks,d,c,B),h(u,Q.minorTicks,d,c,C),g(u,Q.tickLabels,d,c,B,E),j(u,Q.domain,e,D),i(u,Q.title,e,w),r.extend(Q.gridLines.properties.update,K),r.extend(Q.majorTicks.properties.update,M),r.extend(Q.minorTicks.properties.update,N),r.extend(Q.tickLabels.properties.update,L),r.extend(Q.domain.properties.update,P),r.extend(Q.title.properties.update,O);var q=[Q.gridLines,Q.majorTicks,Q.minorTicks,Q.tickLabels,Q.domain,Q.title];r.extend(x,{type:"group",interactive:!1,properties:{enter:{encode:k,scales:[a.scaleName],signals:[],data:[]},update:{encode:k,scales:[a.scaleName],signals:[],data:[]}}}),x.marks=q.map(function(a){return s(b,a)})}var q,u=p.axis.orient,v=0,w=p.axis.titleOffset,x={},y="front",z=!1,A=null,B=p.axis.tickSize,C=p.axis.tickSize,D=p.axis.tickSize,E=p.axis.padding,F=null,G=null,H=null,I=0,J=[p.axis.ticks],K={},L={},M={},N={},O={},P={},Q={gridLines:null,majorTicks:null,minorTicks:null,tickLabels:null,domain:null,title:null},R={};return R.def=function(){x.type||e(q),H=G?"time"===q.type?a.time.format(G):a.format(G):null;var b=function(a){return{data:a}},c=null==F?q.ticks?q.ticks.apply(q,J):q.domain():F,f=d(q,c,I).map(b);c=c.map(b);var g=null==H?q.tickFormat?q.tickFormat.apply(q,J):String:H;c.forEach(function(a){a.label=g(a.data)});var h=A?[A].map(b):[];return x.marks[0].from=function(){return z?c:[]},x.marks[1].from=function(){return c},x.marks[2].from=function(){return f},x.marks[3].from=x.marks[1].from,x.marks[4].from=function(){return[1]},x.marks[5].from=function(){return h},x.offset=v,x.orient=u,x.layer=y,x},R.scale=function(a){return arguments.length?(q!==a&&(q=a,c()),R):q},R.orient=function(a){return arguments.length?(u!==a&&(u=a in t?a+"":p.axis.orient,c()),R):u},R.title=function(a){return arguments.length?(A!==a&&(A=a,c()),R):A},R.ticks=function(){return arguments.length?(J=arguments,R):J},R.tickValues=function(a){return arguments.length?(F=a,R):F},R.tickFormat=function(a){return arguments.length?(G!==a&&(G=a,c()),R):G},R.tickSize=function(a,b){if(!arguments.length)return B;var d=arguments.length-1,e=+a,f=d>1?+b:B,g=d>0?+arguments[d]:B;return(B!==e||C!==f||D!==g)&&c(),B=e,C=f,D=g,R},R.tickSubdivide=function(a){return arguments.length?(I=+a,R):I},R.offset=function(a){return arguments.length?(v=r.isObject(a)?a:+a,R):v},R.tickPadding=function(a){return arguments.length?(E!==+a&&(E=+a,c()),R):E},R.titleOffset=function(a){return arguments.length?(w!==+a&&(w=+a,c()),R):w},R.layer=function(a){return arguments.length?(y!==a&&(y=a,c()),R):y},R.grid=function(a){return arguments.length?(z!==a&&(z=a,c()),R):z},R.gridLineProperties=function(a){return arguments.length?(K!==a&&(K=a),R):K},R.majorTickProperties=function(a){return arguments.length?(M!==a&&(M=a),R):M},R.minorTickProperties=function(a){return arguments.length?(N!==a&&(N=a),R):N},R.tickLabelProperties=function(a){return arguments.length?(L!==a&&(L=a),R):L},R.titleProperties=function(a){return arguments.length?(O!==a&&(O=a),R):O},R.domainProperties=function(a){return arguments.length?(P!==a&&(P=a),R):P},R.reset=function(){c()},R}function d(a,b,c){if(d=[],c&&b.length>1){for(var d,f,g,h=e(a.domain()),i=-1,j=b.length,k=(b[1]-b[0])/++c;++i<j;)for(f=c;--f>0;)(g=+b[i]-f*k)>=h[0]&&d.push(g);for(--i,f=0;++f<c&&(g=+b[i]+f*k)<h[1];)d.push(g)}return d}function e(a){var b=a[0],c=a[a.length-1];return c>b?[b,c]:[c,b]}function f(a){return a.rangeExtent?a.rangeExtent():e(a.range())}function g(a,b,c,d,e,f){e=Math.max(e,0)+f,("left"===a||"top"===a)&&(e*=-1),"top"===a||"bottom"===a?(r.extend(b.properties.enter,{x:c,y:{value:e}}),r.extend(b.properties.update,{x:d,y:{value:e},align:{value:"center"},baseline:{value:v[a]}})):(r.extend(b.properties.enter,{x:{value:e},y:c}),r.extend(b.properties.update,{x:{value:e},y:d,align:{value:u[a]},baseline:{value:"middle"}}))}function h(a,b,c,d,e){var f="left"===a||"top"===a?-1:1;e=1/0===e?"top"===a||"bottom"===a?{group:"mark.group.height",mult:-f}:{group:"mark.group.width",mult:-f}:{value:f*e},"top"===a||"bottom"===a?(r.extend(b.properties.enter,{x:c,y:{value:0},y2:e}),r.extend(b.properties.update,{x:d,y:{value:0},y2:e}),r.extend(b.properties.exit,{x:d})):(r.extend(b.properties.enter,{x:{value:0},x2:e,y:c}),r.extend(b.properties.update,{x:{value:0},x2:e,y:d}),r.extend(b.properties.exit,{y:d}))}function i(a,b,c,d){var e=~~((c[0]+c[1])/2),f="top"===a||"left"===a?-1:1;"bottom"===a||"top"===a?r.extend(b.properties.update,{x:{value:e},y:{value:f*d},angle:{value:0}}):r.extend(b.properties.update,{x:{value:f*d},y:{value:e},angle:{value:-90}})}function j(a,b,c,d){var e;("top"===a||"left"===a)&&(d=-1*d),e="bottom"===a||"top"===a?"M"+c[0]+","+d+"V0H"+c[1]+"V"+d:"M"+d+","+c[0]+"H0V"+c[1]+"H"+d,b.properties.update.path={value:e}}function k(a,b,c){var d=c?{}:a,e=a.mark.def.offset,f=a.mark.def.orient,g=b.width,h=b.height;switch(r.isObject(e)&&(e=-b.scale(e.scale)(e.value)),f){case"left":q.set(d,"x",-e),q.set(d,"y",0);break;case"right":q.set(d,"x",g+e),q.set(d,"y",0);break;case"bottom":q.set(d,"x",0),q.set(d,"y",h+e);break;case"top":q.set(d,"x",0),q.set(d,"y",-e);break;default:q.set(d,"x",0),q.set(d,"y",0)}c&&c.interpolate(a,d)}function l(){return{type:"rule",interactive:!1,key:"data",properties:{enter:{stroke:{value:p.axis.tickColor},strokeWidth:{value:p.axis.tickWidth},opacity:{value:1e-6}},exit:{opacity:{value:1e-6}},update:{opacity:{value:1}}}}}function m(){return{type:"text",interactive:!0,key:"data",properties:{enter:{fill:{value:p.axis.tickLabelColor},font:{value:p.axis.tickLabelFont},fontSize:{value:p.axis.tickLabelFontSize},opacity:{value:1e-6},text:{field:"label"}},exit:{opacity:{value:1e-6}},update:{opacity:{value:1}}}}}function n(){return{type:"text",interactive:!0,properties:{enter:{font:{value:p.axis.titleFont},fontSize:{value:p.axis.titleFontSize},fontWeight:{value:p.axis.titleFontWeight},fill:{value:p.axis.titleColor},align:{value:"center"},baseline:{value:"middle"},text:{field:"data"}},update:{}}}}function o(){return{type:"path",interactive:!1,properties:{enter:{x:{value:.5},y:{value:.5},stroke:{value:p.axis.axisColor},strokeWidth:{value:p.axis.axisWidth}},update:{}}}}var p=b("../util/config"),q=b("../dataflow/tuple"),r=b("../util/index"),s=b("../parse/mark"),t={top:1,right:1,bottom:1,left:1},u={bottom:"center",top:"center",left:"right",right:"left"},v={bottom:"top",top:"bottom",left:"middle",right:"middle"};return c}),f("parse/axes",["require","exports","module","../scene/axis","../util/config","../util/index"],function(a){function b(a,b,e,f){(b||[]).forEach(function(b,g){e[g]=e[g]||d(a),c(b,g,e[g],f)})}function c(a,b,c,d){void 0!==a.scale&&c.scale(d.scale(a.scale)),c.orient(a.orient||g[a.type]),c.offset(a.offset||0),c.layer(a.layer||"front"),c.grid(a.grid||!1),c.title(a.title||null),c.titleOffset(null!=a.titleOffset?a.titleOffset:e.axis.titleOffset),c.tickValues(a.values||null),c.tickFormat(a.format||null),c.tickSubdivide(a.subdivide||0),c.tickPadding(a.tickPadding||e.axis.padding);var h=[];if(void 0!==a.tickSize)for(var i=0;3>i;++i)h.push(a.tickSize);else{var j=e.axis.tickSize;h=[j,j,j]}if(null!=a.tickSizeMajor&&(h[0]=a.tickSizeMajor),null!=a.tickSizeMinor&&(h[1]=a.tickSizeMinor),null!=a.tickSizeEnd&&(h[2]=a.tickSizeEnd),h.length&&c.tickSize.apply(c,h),null!=a.ticks){var k=f.isArray(a.ticks)?a.ticks:[a.ticks];c.ticks.apply(c,k)}else c.ticks(e.axis.ticks);var l=a.properties;l&&l.ticks?(c.majorTickProperties(l.majorTicks?f.extend({},l.ticks,l.majorTicks):l.ticks),c.minorTickProperties(l.minorTicks?f.extend({},l.ticks,l.minorTicks):l.ticks)):(c.majorTickProperties(l&&l.majorTicks||{}),c.minorTickProperties(l&&l.minorTicks||{})),c.tickLabelProperties(l&&l.labels||{}),c.titleProperties(l&&l.title||{}),c.gridLineProperties(l&&l.grid||{}),c.domainProperties(l&&l.axis||{})}var d=a("../scene/axis"),e=a("../util/config"),f=a("../util/index"),g={x:"bottom",y:"left",top:"top",bottom:"bottom",left:"left",right:"right"};return b}),f("scene/GroupBuilder",["require","exports","module","../dataflow/Node","../dataflow/Collector","./Builder","./Scale","../parse/axes","../util/index","../util/constants"],function(a){function b(){return this._children={},this._scaler=null,this._recursor=null,this._scales={},this.scale=e.bind(this),arguments.length?this.init.apply(this,arguments):this}function d(a){var b,d,e,f,i,k=this,l=this._def.marks&&this._def.marks.length>0,m=this._def.axes&&this._def.axes.length>0,o=!1;for(b=0,d=a.add.length;d>b;++b)e=a.add[b],l&&g.call(this,a,e),m&&h.call(this,a,e);for(b=a.add.length-1;b>=0;--b)for(e=a.add[b],j=this._children[e._id].length-1;j>=0;--j)c=this._children[e._id][j],c.builder.connect(),f=c.builder.pipeline(),i=c.builder._def,o=i.type!==p.GROUP,o=o&&void 0!==this._model.data(c.from),o=o&&1==f[f.length-1].listeners().length,c.inline=o,o?c.builder.evaluate(a):this._recursor.addListener(c.builder);for(b=0,d=a.mod.length;d>b;++b)e=a.mod[b],l&&k._children[e._id].forEach(function(a){a.type!=p.MARK||a.inline||void 0===k._model.data(a.from)||k._recursor.removeListener(a.builder)}),m&&(n(k._model,k._def.axes,e.axes,e),e.axes.forEach(function(a){a.def()}));for(b=0,d=a.rem.length;d>b;++b)e=a.rem[b],k._children[e._id].forEach(function(a){k._recursor.removeListener(a.builder),a.builder.disconnect()}),delete k._children[e._id];return a}function e(a,b){var c=this;if(2===arguments.length)return c._scales[a]=b,b;for(;null==b&&(b=c._scales[a],c=c.mark?c.mark.group:c._parent););return b}function f(a,b){o.debug(a,["building group",b._id]),b._scales=b._scales||{},b.scale=e.bind(b),b.items=b.items||[],this._children[b._id]=this._children[b._id]||[],b.axes=b.axes||[],b.axisItems=b.axisItems||[]}function g(a,c){o.debug(a,["building marks",c._id]);var d,e,f,g,h,i,j=this._def.marks;for(g=0,h=j.length;h>g;++g)d=j[g],e=d.from||{},f="vg_"+c.datum._id,c.items[g]={group:c},i=d.type===p.GROUP?new b:new l,i.init(this._model,d,c.items[g],this,c._id,f),this._children[c._id].push({builder:i,from:e.data||(e.mark?"vg_"+c._id+"_"+e.mark:f),type:p.MARK})}function h(a,c){var d=c.axes,e=c.axisItems,f=this;n(this._model,this._def.axes,d,c),d.forEach(function(a,d){var g=f._def.axes[d].scale,h=a.def(),i=null;e[d]={group:c,axisDef:h},i=h.type===p.GROUP?new b:new l,i.init(f._model,h,e[d],f).dependency(p.SCALES,g),f._children[c._id].push({builder:i,type:p.AXIS,scale:g})})}var i=a("../dataflow/Node"),k=a("../dataflow/Collector"),l=a("./Builder"),m=a("./Scale"),n=a("../parse/axes"),o=a("../util/index"),p=a("../util/constants"),q=b.prototype=new l;return q.init=function(a,b){var c=this;this._scaler=new i(a.graph),(b.scales||[]).forEach(function(b){b=c.scale(b.name,new m(a,b,c)),c._scaler.addListener(b)}),this._recursor=new i(a.graph),this._recursor.evaluate=d.bind(this);var e=(b.axes||[]).reduce(function(a,b){return a[b.scale]=1,a},{});return this._recursor.dependency(p.SCALES,o.keys(e)),this._collector=new k(a.graph),l.prototype.init.apply(this,arguments)},q.evaluate=function(){var a=l.prototype.evaluate.apply(this,arguments),b=this;return a.add.forEach(function(c){f.call(b,a,c)}),a},q.pipeline=function(){return[this,this._scaler,this._recursor,this._collector,this._bounder]},q.disconnect=function(){var a=this;return o.keys(a._children).forEach(function(b){a._children[b].forEach(function(b){a._recursor.removeListener(b.builder),b.builder.disconnect()})}),a._children={},l.prototype.disconnect.call(this)},q.child=function(a,b){for(var c,d=this._children[b],e=0,f=d.length;f>e&&(c=d[e],c.type!=p.MARK||c.builder._def.name!=a);++e);return c.builder},b}),f("core/Model",["require","exports","module","../dataflow/Graph","../dataflow/Node","../scene/GroupBuilder","../dataflow/changeset","../util/index"],function(a){function b(){this._defs={},this._predicates={},this._scene=null,this.graph=new d,this._node=new e(this.graph),this._builder=null}function c(a){var b=this,c={};return h.isArray(a)?(a.forEach(function(a){c[a]=b._predicates[a]}),c):this._predicates[a]}var d=a("../dataflow/Graph"),e=a("../dataflow/Node"),f=a("../scene/GroupBuilder"),g=a("../dataflow/changeset"),h=a("../util/index"),i=b.prototype;return i.defs=function(a){return arguments.length?(this._defs=a,this):this._defs},i.data=function(){var a=this.graph.data.apply(this.graph,arguments);return arguments.length>1&&this._node.addListener(a.pipeline()[0]),a},i.width=function(a){return this._defs&&(this._defs.width=a),this._defs&&this._defs.marks&&(this._defs.marks.width=a),this._scene&&(this._scene.items[0].width=a),this},i.height=function(a){return this._defs&&(this._defs.height=a),this._defs&&this._defs.marks&&(this._defs.marks.height=a),this._scene&&(this._scene.items[0].height=a),this},i.predicate=function(a,b){return 1===arguments.length?c.call(this,a):this._predicates[a]=b},i.predicates=function(){return this._predicates},i.scene=function(a){if(!arguments.length)return this._scene;this._builder&&this._node.removeListener(this._builder.disconnect()),this._builder=new f(this,this._defs.marks,this._scene={}),this._node.addListener(this._builder.connect());var b=this._builder.pipeline();return b[b.length-1].addListener(a),this},i.addListener=function(a){this._node.addListener(a)},i.removeListener=function(a){this._node.removeListener(a)},i.fire=function(a){a||(a=g.create()),this.graph.propagate(a,this._node)},b}),f("parse/events",[],function(){function a(a,b){function c(){this.constructor=a}c.prototype=b.prototype,a.prototype=new c}function b(a,b,c,d,e,f){this.message=a,this.expected=b,this.found=c,this.offset=d,this.line=e,this.column=f,this.name="SyntaxError"}function c(a){function c(b){function c(b,c,d){var e,f;for(e=c;d>e;e++)f=a.charAt(e),"\n"===f?(b.seenCR||b.line++,b.column=1,b.seenCR=!1):"\r"===f||"\u2028"===f||"\u2029"===f?(b.line++,b.column=1,b.seenCR=!0):(b.column++,b.seenCR=!1)}return Nb!==b&&(Nb>b&&(Nb=0,Ob={line:1,column:1,seenCR:!1}),c(Ob,Nb,b),Nb=b),Ob}function d(a){Pb>Lb||(Lb>Pb&&(Pb=Lb,Qb=[]),Qb.push(a))}function e(d,e,f){function g(a){var b=1;for(a.sort(function(a,b){return a.description<b.description?-1:a.description>b.description?1:0});b<a.length;)a[b-1]===a[b]?a.splice(b,1):b++}function h(a,b){function c(a){function b(a){return a.charCodeAt(0).toString(16).toUpperCase()}return a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(a){return"\\x0"+b(a)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(a){return"\\x"+b(a)}).replace(/[\u0180-\u0FFF]/g,function(a){return"\\u0"+b(a)}).replace(/[\u1080-\uFFFF]/g,function(a){return"\\u"+b(a)})}var d,e,f,g=new Array(a.length);for(f=0;f<a.length;f++)g[f]=a[f].description;return d=a.length>1?g.slice(0,-1).join(", ")+" or "+g[a.length-1]:g[0],e=b?'"'+c(b)+'"':"end of input","Expected "+d+" but "+e+" found."}var i=c(f),j=f<a.length?a.charAt(f):null;return null!==e&&g(e),new b(null!==d?d:h(e,j),e,j,f,i.line,i.column)}function f(){var a;return a=g()}function g(){var b,c,e,f,i,j;return b=Lb,c=h(),c!==s?(e=p(),e!==s?(44===a.charCodeAt(Lb)?(f=w,Lb++):(f=s,0===Rb&&d(x)),f!==s?(i=p(),i!==s?(j=g(),j!==s?(Mb=b,c=y(c,j),b=c):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v),b===s&&(b=Lb,c=h(),c!==s&&(Mb=b,c=z(c)),b=c),b}function h(){var b,c,e,f,g,j,k,l,m,n,o,q,r,t;return b=Lb,91===a.charCodeAt(Lb)?(c=A,Lb++):(c=s,0===Rb&&d(B)),c!==s?(e=p(),e!==s?(f=i(),f!==s?(g=p(),g!==s?(44===a.charCodeAt(Lb)?(j=w,Lb++):(j=s,0===Rb&&d(x)),j!==s?(k=p(),k!==s?(l=i(),l!==s?(m=p(),m!==s?(93===a.charCodeAt(Lb)?(n=C,Lb++):(n=s,0===Rb&&d(D)),n!==s?(o=p(),o!==s?(62===a.charCodeAt(Lb)?(q=E,Lb++):(q=s,0===Rb&&d(F)),q!==s?(r=p(),r!==s?(t=h(),t!==s?(Mb=b,c=G(f,l,t),b=c):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v),b===s&&(b=i()),b}function i(){var a,b,c,d;if(a=Lb,b=j(),b!==s){if(c=[],d=n(),d!==s)for(;d!==s;)c.push(d),d=n();else c=v;c!==s?(Mb=a,b=H(b,c),a=b):(Lb=a,a=v)}else Lb=a,a=v;return a===s&&(a=Lb,b=j(),b!==s&&(Mb=a,b=I(b)),a=b),a}function j(){var b,c,e,f;if(b=Lb,c=k(),c===s&&(c=l()),c===s&&(c=J),c!==s?(e=m(),e!==s?(Mb=b,c=K(c,e),b=c):(Lb=b,b=v)):(Lb=b,b=v),b===s){if(b=Lb,c=[],L.test(a.charAt(Lb))?(e=a.charAt(Lb),Lb++):(e=s,0===Rb&&d(M)),e!==s)for(;e!==s;)c.push(e),L.test(a.charAt(Lb))?(e=a.charAt(Lb),Lb++):(e=s,0===Rb&&d(M));else c=v;c!==s&&(Mb=b,c=N(c)),b=c,b===s&&(b=Lb,40===a.charCodeAt(Lb)?(c=O,Lb++):(c=s,0===Rb&&d(P)),c!==s?(e=g(),e!==s?(41===a.charCodeAt(Lb)?(f=Q,Lb++):(f=s,0===Rb&&d(R)),f!==s?(Mb=b,c=S(e),b=c):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v))}return b}function k(){var b,c,e,f;return b=Lb,46===a.charCodeAt(Lb)?(c=T,Lb++):(c=s,0===Rb&&d(U)),c!==s?(e=o(),e!==s?(58===a.charCodeAt(Lb)?(f=V,Lb++):(f=s,0===Rb&&d(W)),f!==s?(Mb=b,c=X(e),b=c):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v),b}function l(){var b,c,e,f;return b=Lb,35===a.charCodeAt(Lb)?(c=Y,Lb++):(c=s,0===Rb&&d(Z)),c!==s?(e=o(),e!==s?(58===a.charCodeAt(Lb)?(f=V,Lb++):(f=s,0===Rb&&d(W)),f!==s?(Mb=b,c=$(e),b=c):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v),b}function m(){var b;return a.substr(Lb,9)===_?(b=_,Lb+=9):(b=s,0===Rb&&d(ab)),b===s&&(a.substr(Lb,7)===bb?(b=bb,Lb+=7):(b=s,0===Rb&&d(cb)),b===s&&(a.substr(Lb,5)===db?(b=db,Lb+=5):(b=s,0===Rb&&d(eb)),b===s&&(a.substr(Lb,8)===fb?(b=fb,Lb+=8):(b=s,0===Rb&&d(gb)),b===s&&(a.substr(Lb,5)===hb?(b=hb,Lb+=5):(b=s,0===Rb&&d(ib)),b===s&&(a.substr(Lb,7)===jb?(b=jb,Lb+=7):(b=s,0===Rb&&d(kb)),b===s&&(a.substr(Lb,8)===lb?(b=lb,Lb+=8):(b=s,0===Rb&&d(mb)),b===s&&(a.substr(Lb,5)===nb?(b=nb,Lb+=5):(b=s,0===Rb&&d(ob)),b===s&&(a.substr(Lb,10)===pb?(b=pb,Lb+=10):(b=s,0===Rb&&d(qb)),b===s&&(a.substr(Lb,9)===rb?(b=rb,Lb+=9):(b=s,0===Rb&&d(sb)),b===s&&(a.substr(Lb,8)===tb?(b=tb,Lb+=8):(b=s,0===Rb&&d(ub)),b===s&&(a.substr(Lb,9)===vb?(b=vb,Lb+=9):(b=s,0===Rb&&d(wb)),b===s&&(a.substr(Lb,10)===xb?(b=xb,Lb+=10):(b=s,0===Rb&&d(yb)),b===s&&(a.substr(Lb,10)===zb?(b=zb,Lb+=10):(b=s,0===Rb&&d(Ab)),b===s&&(a.substr(Lb,9)===Bb?(b=Bb,Lb+=9):(b=s,0===Rb&&d(Cb)),b===s&&(a.substr(Lb,8)===Db?(b=Db,Lb+=8):(b=s,0===Rb&&d(Eb))))))))))))))))),b
}function n(){var b,c,e,f;return b=Lb,91===a.charCodeAt(Lb)?(c=A,Lb++):(c=s,0===Rb&&d(B)),c!==s?(e=o(),e!==s?(93===a.charCodeAt(Lb)?(f=C,Lb++):(f=s,0===Rb&&d(D)),f!==s?(Mb=b,c=Fb(e),b=c):(Lb=b,b=v)):(Lb=b,b=v)):(Lb=b,b=v),b}function o(){var b,c,e;if(b=Lb,c=[],Gb.test(a.charAt(Lb))?(e=a.charAt(Lb),Lb++):(e=s,0===Rb&&d(Hb)),e!==s)for(;e!==s;)c.push(e),Gb.test(a.charAt(Lb))?(e=a.charAt(Lb),Lb++):(e=s,0===Rb&&d(Hb));else c=v;return c!==s&&(Mb=b,c=Ib(c)),b=c}function p(){var b,c;for(b=[],Jb.test(a.charAt(Lb))?(c=a.charAt(Lb),Lb++):(c=s,0===Rb&&d(Kb));c!==s;)b.push(c),Jb.test(a.charAt(Lb))?(c=a.charAt(Lb),Lb++):(c=s,0===Rb&&d(Kb));return b}var q,r=arguments.length>1?arguments[1]:{},s={},t={start:f},u=f,v=s,w=",",x={type:"literal",value:",",description:'","'},y=function(a,b){return[a].concat(b)},z=function(a){return[a]},A="[",B={type:"literal",value:"[",description:'"["'},C="]",D={type:"literal",value:"]",description:'"]"'},E=">",F={type:"literal",value:">",description:'">"'},G=function(a,b,c){return{start:a,end:b,middle:c}},H=function(a,b){return a.filters=b,a},I=function(a){return a},J=null,K=function(a,b){return{event:b,target:a}},L=/^[:a-zA-z0-9_\-]/,M={type:"class",value:"[:a-zA-z0-9_\\-]",description:"[:a-zA-z0-9_\\-]"},N=function(a){return{signal:a.join("")}},O="(",P={type:"literal",value:"(",description:'"("'},Q=")",R={type:"literal",value:")",description:'")"'},S=function(a){return{stream:a}},T=".",U={type:"literal",value:".",description:'"."'},V=":",W={type:"literal",value:":",description:'":"'},X=function(a){return{type:"class",value:a}},Y="#",Z={type:"literal",value:"#",description:'"#"'},$=function(a){return{type:"id",value:a}},_="mousedown",ab={type:"literal",value:"mousedown",description:'"mousedown"'},bb="mouseup",cb={type:"literal",value:"mouseup",description:'"mouseup"'},db="click",eb={type:"literal",value:"click",description:'"click"'},fb="dblclick",gb={type:"literal",value:"dblclick",description:'"dblclick"'},hb="wheel",ib={type:"literal",value:"wheel",description:'"wheel"'},jb="keydown",kb={type:"literal",value:"keydown",description:'"keydown"'},lb="keypress",mb={type:"literal",value:"keypress",description:'"keypress"'},nb="keyup",ob={type:"literal",value:"keyup",description:'"keyup"'},pb="mousewheel",qb={type:"literal",value:"mousewheel",description:'"mousewheel"'},rb="mousemove",sb={type:"literal",value:"mousemove",description:'"mousemove"'},tb="mouseout",ub={type:"literal",value:"mouseout",description:'"mouseout"'},vb="mouseover",wb={type:"literal",value:"mouseover",description:'"mouseover"'},xb="mouseenter",yb={type:"literal",value:"mouseenter",description:'"mouseenter"'},zb="touchstart",Ab={type:"literal",value:"touchstart",description:'"touchstart"'},Bb="touchmove",Cb={type:"literal",value:"touchmove",description:'"touchmove"'},Db="touchend",Eb={type:"literal",value:"touchend",description:'"touchend"'},Fb=function(a){return a},Gb=/^['"a-zA-Z0-9_.><=! \t\-]/,Hb={type:"class",value:"['\"a-zA-Z0-9_.><=! \\t\\-]",description:"['\"a-zA-Z0-9_.><=! \\t\\-]"},Ib=function(a){return a.join("")},Jb=/^[ \t\r\n]/,Kb={type:"class",value:"[ \\t\\r\\n]",description:"[ \\t\\r\\n]"},Lb=0,Mb=0,Nb=0,Ob={line:1,column:1,seenCR:!1},Pb=0,Qb=[],Rb=0;if("startRule"in r){if(!(r.startRule in t))throw new Error("Can't start parsing from rule \""+r.startRule+'".');u=t[r.startRule]}if(q=u(),q!==s&&Lb===a.length)return q;throw q!==s&&Lb<a.length&&d({type:"end",description:"end of input"}),e(null,Qb,Pb)}return a(b,Error),{SyntaxError:b,parse:c}}),f("parse/streams",["require","exports","module","d3","../dataflow/Node","../dataflow/changeset","./events","./expr","../util/index","../util/constants"],function(a){var b=a("d3"),c=a("../dataflow/Node"),d=a("../dataflow/changeset"),e=a("./events"),f=a("./expr"),g=a("../util/index"),h=a("../util/constants"),i="start",j="middle",k="end";return function(a){function l(a,b,c){c&&c.scale||(c=c&&c.mark?c.mark.group:q.scene().items[0]);var d=c.scale(a.scale.signal||a.scale);return d?a.invert?d.invert(b):d(b):b}function m(a,b,d,e){var g=new c(r),i=e.item?r.signal(e.item.signal):null;g.evaluate=function(c){if(!c.signals[b.signal])return r.doNotPropagate;var g=f.eval(r,d.fn,null,null,null,null,d.signals);return e.scale&&(g=l(e,g,i?i.value():null)),a.value(g),c.signals[a.name()]=1,c.reflow=!0,c},g.dependency(h.SIGNALS,b.signal),g.addListener(a),r.signal(b.signal).addListener(g)}function n(a,b,d,e){var h=b.filters||[],i=b.target;i&&h.push("i."+i.type+"=="+g.str(i.value)),t[b.event]=t[b.event]||[],t[b.event].push({signal:a,exp:d,filters:h.map(function(a){return f(r,a)}),spec:e}),u[b.event]=u[b.event]||new c(r),u[b.event].addListener(a)}function o(a,b,d,e){var g=a.name(),h=f(r,"true"),l={};l[i]=r.signal(g+i,!1),l[j]=r.signal(g+j,!1),l[k]=r.signal(g+k,!1);var o=new c(r);o.evaluate=function(b){return l[i].value()===!0&&l[k].value()===!1?b.signals[g+i]?r.doNotPropagate:(a.value(l[j].value()),b.signals[g]=1,b):(l[k].value()===!0&&(l[i].value(!1),l[k].value(!1)),r.doNotPropagate)},o.addListener(a),[i,j,k].forEach(function(a){var c=a==j?d:h,f=a==j?e:{};b[a].event?n(l[a],b[a],c,f):b[a].signal?m(l[a],b[a],c,f):b[a].stream&&p(l[a],b[a].stream,c,f),l[a].addListener(o)})}function p(a,b,c,d){b.forEach(function(b){b.event?n(a,b,c,d):b.signal?m(a,b,c,d):b.start?o(a,b,c,d):b.stream&&p(a,b.stream,c,d)})}var q=a.model(),r=q.graph,s=q.defs().signals,t={},u={};(s||[]).forEach(function(a){var b=r.signal(a.name);a.expr||(a.streams||[]).forEach(function(a){var c=e.parse(a.type),d=f(r,a.expr);p(b,c,d,a)})}),g.keys(t).forEach(function(c){var e=t[c],g=u[c];a.on(c,function(c,h){var i,j,k,m,n,o=d.create(null,!0),p=a.padding(),q=!1;c.preventDefault(),m=b.mouse((b.event=c,a._el)),h=h||{},n=h.datum||{};var s={x:m[0]-p.left,y:m[1]-p.top};for(k=0;k<e.length;k++)j=e[k],q=j.filters.some(function(a){return!f.eval(r,a.fn,n,c,h,s,a.signals)}),q||(i=f.eval(r,j.exp.fn,n,c,h,s,j.exp.signals),j.spec.scale&&(i=l(j.spec,i,h)),j.signal.value(i),o.signals[j.signal.name()]=1);r.propagate(o,g)})})}}),f("render/canvas/marks",["require","exports","module","../../core/Bounds","../../util/bounds","../../util/index","../../util/config","./path"],function(a){function b(a,b){var c=b.x||0,d=b.y||0,e=b.innerRadius||0,f=b.outerRadius||0,g=(b.startAngle||0)-Math.PI/2,h=(b.endAngle||0)-Math.PI/2;a.beginPath(),0===e?a.moveTo(c,d):a.arc(c,d,e,g,h,0),a.arc(c,d,f,h,g,1),a.closePath()}function c(a,b){var c=b[0],d=c.mark,e=d.pathCache||(d.pathCache=E(D.area(b)));F(a,e)}function d(a,b){var c=b[0],d=c.mark,e=d.pathCache||(d.pathCache=E(D.line(b)));F(a,e)}function e(a,b){if(null!=b.path){var c=b.pathCache||(b.pathCache=E(b.path));return F(a,c,b.x,b.y)}}function f(a,b){a.beginPath();var c,d,e,f,g=null!=b.size?b.size:100,h=b.x,i=b.y;if(null==b.shape||"circle"===b.shape)return c=Math.sqrt(g/Math.PI),a.arc(h,i,c,0,2*Math.PI,0),void a.closePath();switch(b.shape){case"cross":c=Math.sqrt(g/5)/2,d=3*c,a.moveTo(h-d,i-c),a.lineTo(h-c,i-c),a.lineTo(h-c,i-d),a.lineTo(h+c,i-d),a.lineTo(h+c,i-c),a.lineTo(h+d,i-c),a.lineTo(h+d,i+c),a.lineTo(h+c,i+c),a.lineTo(h+c,i+d),a.lineTo(h-c,i+d),a.lineTo(h-c,i+c),a.lineTo(h-d,i+c);break;case"diamond":f=Math.sqrt(g/(2*H)),e=f*H,a.moveTo(h,i-f),a.lineTo(h+e,i),a.lineTo(h,i+f),a.lineTo(h-e,i);break;case"square":d=Math.sqrt(g),c=d/2,a.rect(h-c,i-c,d,d);break;case"triangle-down":e=Math.sqrt(g/G),f=e*G/2,a.moveTo(h,i+f),a.lineTo(h+e,i-f),a.lineTo(h-e,i-f);break;case"triangle-up":e=Math.sqrt(g/G),f=e*G/2,a.moveTo(h,i-f),a.lineTo(h+e,i+f),a.lineTo(h-e,i+f)}a.closePath()}function g(a,b){var c=b[0],e=c.strokeWidth,f=c.strokeCap;a.lineWidth=null!=e?e:C.render.lineWidth,a.lineCap=null!=f?f:C.render.lineCap,d(a,b)}function h(a,b){var c=b.x||0,d=b.y||0,e=null!=b.x2?b.x2:c,f=null!=b.y2?b.y2:d,g=b.strokeWidth,h=b.strokeCap;a.lineWidth=null!=g?g:C.render.lineWidth,a.lineCap=null!=h?h:C.render.lineCap,a.beginPath(),a.moveTo(c,d),a.lineTo(e,f)}function i(a,b,c,d){var e,f,g,h=c.fill,i=c.stroke;a(b,d),e=null==c.opacity?1:c.opacity,0!=e&&(h||i)&&(h&&(b.globalAlpha=e*(null==c.fillOpacity?1:c.fillOpacity),b.fillStyle=r(b,c,h),b.fill()),i&&(g=null!=(g=c.strokeWidth)?g:C.render.lineWidth,g>0&&(b.globalAlpha=e*(null==c.strokeOpacity?1:c.strokeOpacity),b.strokeStyle=r(b,c,i),b.lineWidth=g,b.lineCap=null!=(f=c.strokeCap)?f:C.render.lineCap,b.vgLineDash(c.strokeDash||null),b.vgLineDashOffset(c.strokeDashOffset||0),b.stroke())))}function j(a,b,c,d){var e,f,g;for(e=0,f=c.items.length;f>e;++e)g=c.items[e],(!d||d.intersects(g.bounds))&&i(a,b,g,g)}function k(a,b,c){if(b.items.length)for(var d,e,f,g,h,i,j,k,l,m,n=b.items,o=0,p=n.length;p>o;++o)d=n[o],(!c||c.intersects(d.bounds))&&(j=d.x||0,k=d.y||0,l=d.width||0,m=d.height||0,g=null==d.opacity?1:d.opacity,0!=g&&((e=d.fill)&&(a.globalAlpha=g*(null==d.fillOpacity?1:d.fillOpacity),a.fillStyle=r(a,d,e),a.fillRect(j,k,l,m)),(f=d.stroke)&&(i=null!=(i=d.strokeWidth)?i:C.render.lineWidth,i>0&&(a.globalAlpha=g*(null==d.strokeOpacity?1:d.strokeOpacity),a.strokeStyle=r(a,d,f),a.lineWidth=i,a.lineCap=null!=(h=d.strokeCap)?h:C.render.lineCap,a.vgLineDash(d.strokeDash||null),a.vgLineDashOffset(d.strokeDashOffset||0),a.strokeRect(j,k,l,m)))))}function l(a,b,c){if(b.items.length)for(var d,e,f,g,h,i,j,k,l,m=b.items,n=0,o=m.length;o>n;++n)d=m[n],(!c||c.intersects(d.bounds))&&(i=d.x||0,j=d.y||0,k=null!=d.x2?d.x2:i,l=null!=d.y2?d.y2:j,f=null==d.opacity?1:d.opacity,0!=f&&(e=d.stroke)&&(h=null!=(h=d.strokeWidth)?h:C.render.lineWidth,h>0&&(a.globalAlpha=f*(null==d.strokeOpacity?1:d.strokeOpacity),a.strokeStyle=r(a,d,e),a.lineWidth=h,a.lineCap=null!=(g=d.strokeCap)?g:C.render.lineCap,a.vgLineDash(d.strokeDash||null),a.vgLineDashOffset(d.strokeDashOffset||0),a.beginPath(),a.moveTo(i,j),a.lineTo(k,l),a.stroke())))}function m(a,b,c){if(b.items.length)for(var d,e=this,f=b.items,g=0,h=f.length;h>g;++g)if(d=f[g],!c||c.intersects(d.bounds)){d.image&&d.image.url===d.url||(d.image=e.loadImage(d.url),d.image.url=d.url);var i,j,k,l,m;k=d.width||d.image&&d.image.width||0,l=d.height||d.image&&d.image.height||0,i=(d.x||0)-("center"===d.align?k/2:"right"===d.align?k:0),j=(d.y||0)-("middle"===d.baseline?l/2:"bottom"===d.baseline?l:0),d.image.loaded&&(a.globalAlpha=null!=(m=d.opacity)?m:1,a.drawImage(d.image,i,j,k,l))}}function n(a,b,c){if(b.items.length)for(var d,e,f,g,h,i,j,k,l,m=b.items,n=0,o=m.length;o>n;++n)d=m[n],(!c||c.intersects(d.bounds))&&(a.font=B.fontString(d),a.textAlign=d.align||"left",a.textBaseline=d.baseline||"alphabetic",g=null==d.opacity?1:d.opacity,0!=g&&(i=d.x||0,j=d.y||0,(k=d.radius)&&(l=(d.theta||0)-Math.PI/2,i+=k*Math.cos(l),j+=k*Math.sin(l)),d.angle?(a.save(),a.translate(i,j),a.rotate(d.angle*Math.PI/180),i=d.dx||0,j=d.dy||0):(i+=d.dx||0,j+=d.dy||0),(e=d.fill)&&(a.globalAlpha=g*(null==d.fillOpacity?1:d.fillOpacity),a.fillStyle=r(a,d,e),a.fillText(d.text,i,j)),(f=d.stroke)&&(h=null!=(h=d.strokeWidth)?h:1,h>0&&(a.globalAlpha=g*(null==d.strokeOpacity?1:d.strokeOpacity),a.strokeStyle=r(d,f),a.lineWidth=h,a.strokeText(d.text,i,j))),d.angle&&a.restore()))}function o(a){return function(b,c,d){j(a,b,c,d)}}function p(a){return function(b,c,d){c.items.length&&(!d||d.intersects(c.items[0].bounds))&&i(a,b,c.items[0],c.items)}}function q(a,b,c){if(b.items.length){var d,e,f,g,h,i,j,l,m,n=b.items,o=this;for(k(a,b,c),i=0,j=n.length;j>i;++i){for(d=n[i],e=d.axisItems||[],f=d.legendItems||[],g=d.x||0,h=d.y||0,a.save(),a.translate(g,h),d.clip&&(a.beginPath(),a.rect(0,0,d.width||0,d.height||0),a.clip()),c&&c.translate(-g,-h),l=0,m=e.length;m>l;++l)"back"===e[l].def.layer&&o.draw(a,e[l],c);for(l=0,m=d.items.length;m>l;++l)o.draw(a,d.items[l],c);for(l=0,m=e.length;m>l;++l)"back"!==e[l].def.layer&&o.draw(a,e[l],c);for(l=0,m=f.length;m>l;++l)o.draw(a,f[l],c);c&&c.translate(g,h),a.restore()}}}function r(a,b,c){return c.id?s(a,c,b.bounds):c}function s(a,b,c){var d,e,f=c.width(),g=c.height(),h=c.x1+b.x1*f,i=c.y1+b.y1*g,j=c.x1+b.x2*f,k=c.y1+b.y2*g,l=a.createLinearGradient(h,i,j,k),m=b.stops;for(d=0,e=m.length;e>d;++d)l.addColorStop(m[d].offset,m[d].color);return l}function t(a,b,c,d,e,f){if(0===b.items.length||b.bounds&&!b.bounds.contains(e,f))return!1;var g,h,i,j,k,l,m,n=b.items,o=this;for(l=n.length;--l>=0;){for(h=n[l],j=h.x||0,k=h.y||0,a.save(),a.translate(j,k),m=h.items.length;--m>=0;)if(g=h.items[m],g.interactive!==!1&&(i=o.pick(g,c,d,e-j,f-k)))return a.restore(),i;a.restore()}return b.interactive?u(J.group,a,b,c,d,e,f):!1}function u(a,b,c,d,e,f,g){if(!c.items.length)return!1;var h,i,j;for(1!==b._ratio&&(d*=b._ratio,e*=b._ratio),j=c.items.length;--j>=0;)if(h=c.items[j],i=h.bounds,(!i||i.contains(f,g))&&i&&a(b,h,d,e,f,g))return h;return!1}function v(a,b,c,d,e,f){if(!b.items.length)return!1;var g,h=b.items;return g=h[0].bounds,g&&!g.contains(e,f)?!1:(1!==a._ratio&&(c*=a._ratio,d*=a._ratio),J.area(a,h,c,d)?h[0]:!1)}function w(a,b,c,d,e,f){if(!b.items.length)return!1;var g,h=b.items;return g=h[0].bounds,g&&!g.contains(e,f)?!1:(1!==a._ratio&&(c*=a._ratio,d*=a._ratio),J.line(a,h,c,d)?h[0]:!1)}function x(a){return function(b,c,d,e,f,g){return u(a,b,c,d,e,f,g)}}function y(a,b,c,d,e,f){if(!b.fontSize)return!1;if(!b.angle)return!0;var g=A.text(b,I,!0),h=-b.angle*Math.PI/180,i=Math.cos(h),j=Math.sin(h),c=b.x,d=b.y,k=i*e-j*f+(c-c*i+d*j),l=j*e+i*f+(d-c*j-d*i);return g.contains(k,l)}var z=a("../../core/Bounds"),A=a("../../util/bounds"),B=a("../../util/index"),C=a("../../util/config"),D=a("./path"),E=D.parse,F=D.render,G=(Math.PI/2,Math.sqrt(3)),H=Math.tan(30*Math.PI/180),I=new z,J={text:y,rect:function(){return!0},image:function(){return!0},group:function(a,b){return b.fill||b.stroke},rule:function(a,b,c,d){return a.isPointInStroke?(h(a,b),a.isPointInStroke(c,d)):!1},line:function(a,b,c,d){return a.isPointInStroke?(g(a,b),a.isPointInStroke(c,d)):!1},arc:function(a,c,d,e){return b(a,c),a.isPointInPath(d,e)},area:function(a,b,d,e){return c(a,b),a.isPointInPath(d,e)},path:function(a,b,c,d){return e(a,b),a.isPointInPath(c,d)},symbol:function(a,b,c,d){return f(a,b),a.isPointInPath(c,d)}};return{draw:{group:q,area:p(c),line:p(d),arc:o(b),path:o(e),symbol:o(f),rect:k,rule:l,text:n,image:m,drawOne:p,drawAll:o},pick:{group:t,area:v,line:w,arc:x(J.arc),path:x(J.path),symbol:x(J.symbol),rect:x(J.rect),rule:x(J.rule),text:x(J.text),image:x(J.image),pickAll:u}}}),f("render/canvas/Handler",["require","exports","module","d3","../../util/index","./marks"],function(a){function b(a){var b=a.indexOf(".");return 0>b?a:a.slice(0,b)}var c=a("d3"),d=a("../../util/index"),e=a("./marks"),f=function(a,b){this._active=null,this._handlers={},a&&this.initialize(a),b&&this.model(b)},g=f.prototype;g.initialize=function(a,b,d){this._el=c.select(a).node(),this._canvas=c.select(a).select("canvas.marks").node(),this._padding=b,this._obj=d||null;var e=this._canvas,f=this;return h.forEach(function(a){e.addEventListener(a,function(b){g[a].call(f,b)})}),this},g.padding=function(a){return this._padding=a,this},g.model=function(a){return arguments.length?(this._model=a,this):this._model},g.handlers=function(){var a=this._handlers;return d.keys(a).reduce(function(b,c){return a[c].reduce(function(a,b){return a.push(b),a},b)},[])};var h=["mousedown","mouseup","click","dblclick","wheel","keydown","keypress","keyup","mousewheel","touchstart"];return h.forEach(function(a){g[a]=function(b){this.fire(a,b)}}),h.push("mousemove"),h.push("mouseout"),h.push("touchmove"),h.push("touchend"),g.touchmove=g.mousemove=function(a){var b=this._padding,c=a.target.getBoundingClientRect(),d=a.clientX-c.left,e=a.clientY-c.top,f=this._active,g=this.pick(this._model.scene(),d,e,d-b.left,e-b.top);return g===f?(this.fire("mousemove",a),void("touchmove"==a.type&&this.fire("touchmove",a))):(f&&(this.fire("mouseout",a),"touchend"==a.type&&this.fire("touchend",a)),this._active=g,void(g&&(this.fire("mouseover",a),"touchstart"==a.type&&this.fire("touchstart",a))))},g.touchend=g.mouseout=function(a){this._active&&(this.fire("mouseout",a),this.fire("touchend",a)),this._active=null},g.DOMMouseScroll=function(a){this.fire("mousewheel",a)},g.fire=function(a,b){var c=this._active,d=this._handlers[a];if(d)for(var e=0,f=d.length;f>e;++e)d[e].handler.call(this._obj,b,c)},g.on=function(a,c){var d=b(a),e=this._handlers;return e=e[d]||(e[d]=[]),e.push({type:a,handler:c}),this},g.off=function(a,c){var d=b(a),e=this._handlers[d];if(e){for(var f=e.length;--f>=0;)e[f].type===a&&(c&&e[f].handler!==c||e.splice(f,1));return this}},g.context=function(){return this._canvas.getContext("2d")},g.pick=function(a,b,c,d,f){var g=this.context(),h=a.marktype,i=e.pick[h];return i.call(this,g,a,b,c,d,f)},f}),f("render/canvas/Renderer",["require","exports","module","d3","../../core/Bounds","../../util/load","../../util/config","./marks"],function(a){function b(a,b){var c=window.devicePixelRatio||1,d=b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1,e=c/d;if(c!==d){var f=a.width,g=a.height;a.setAttribute("width",f*e),a.setAttribute("height",g*e),a.style.width=f+"px",a.style.height=g+"px"}return e}function c(a){if(!a.vgLineDash){var b=[];a.setLineDash?(a.vgLineDash=function(a){this.setLineDash(a||b)},a.vgLineDashOffset=function(a){this.lineDashOffset=a}):void 0!==a.webkitLineDash?(a.vgLineDash=function(a){this.webkitLineDash=a||b},a.vgLineDashOffset=function(a){this.webkitLineDashOffset=a}):void 0!==a.mozDash?(a.vgLineDash=function(a){this.mozDash=a},a.vgLineDashOffset=function(){}):(a.vgLineDash=function(){},a.vgLineDashOffset=function(){})}}function d(a,b){for(var c=new h(b);null!=(a=a.mark.group);)c.translate(a.x||0,a.y||0);return c}function e(a){return a?util.array(a).reduce(function(a,b){return a.union(d(b,b.bounds)).union(d(b,b["bounds:prev"]))},new h):null}function f(a,b){var c=null;return b&&(c=new h(b).round(),a.beginPath(),a.rect(c.x1,c.y1,c.width(),c.height()),a.clip()),c}var g=a("d3"),h=a("../../core/Bounds"),i=a("../../util/load"),j=a("../../util/config"),k=a("./marks"),l=function(){this._ctx=null,this._el=null,this._imgload=0},m=l.prototype;return m.initialize=function(a,b,c,d){if(this._el=a,!a)return this;var e=g.select(a).selectAll("canvas.marks").data([1]);return e.enter().append("canvas").attr("class","marks"),e.exit().remove(),this.resize(b,c,d)},m.resize=function(a,d,e){if(this._width=a,this._height=d,this._padding=e,this._el){var f=g.select(this._el).select("canvas.marks");f.attr("width",a+e.left+e.right).attr("height",d+e.top+e.bottom);var h;this._ctx=f.node().getContext("2d"),this._ctx._ratio=h=b(f.node(),this._ctx)||1,this._ctx.setTransform(h,0,0,h,h*e.left,h*e.top),c(this._ctx)}return this},m.context=function(a){return a?(this._ctx=a,this):this._ctx},m.element=function(){return this._el},m.pendingImages=function(){return this._imgload},m.render=function(a,b){var c,d=this._ctx,g=this._padding,h=this._width+g.left+g.right,i=this._height+g.top+g.bottom,j=null;this._scene=a,d.save(),j=f(d,e(b)),d.clearRect(-g.left,-g.top,h,i),this.draw(d,a,j),b&&(d.restore(),d.save(),c=f(d,e(b)),j.encloses(c)||(d.clearRect(-g.left,-g.top,h,i),this.draw(d,a,c))),d.restore(),this._scene=null},m.draw=function(a,b,c){var d=b.marktype,e=k.draw[d];e.call(this,a,b,c)},m.renderAsync=function(a){var b=this;b._async_id&&clearTimeout(b._async_id),b._async_id=setTimeout(function(){b.render(a),delete b._async_id},50)},m.loadImage=function(b){var c,d=this,e=d._scene,f=null;if(d._imgload+=1,j.isNode){var g="canvas";f=new(a(g).Image),i(b,function(a,b){return a?void util.error(a):(f.src=b,f.loaded=!0,void(d._imgload-=1))})}else f=new Image,c=j.baseURL+b,f.onload=function(){util.log("LOAD IMAGE: "+c),f.loaded=!0,d._imgload-=1,d.renderAsync(e)},f.src=c;return f},l}),f("render/canvas/index",["require","exports","module","./Handler","./Renderer"],function(a){return{Handler:a("./Handler"),Renderer:a("./Renderer")}}),f("render/svg/Handler",["require","exports","module","../../util/index","d3"],function(a){function b(a){var b=this;return function(c){var d=c.target,e=d.__data__;e&&(e=e.mark?e:e[0]),a.call(b._obj,c,e)}}function c(a){var b=a.indexOf(".");return 0>b?a:a.slice(0,b)}var d=a("../../util/index"),e=a("d3"),f=function(a,b){this._active=null,this._handlers={},a&&this.initialize(a),b&&this.model(b)},g=f.prototype;return g.initialize=function(a,b,c){return this._el=e.select(a).node(),this._svg=e.select(a).select("svg.marks").node(),this._padding=b,this._obj=c||null,this},g.padding=function(a){return this._padding=a,this},g.model=function(a){return arguments.length?(this._model=a,this):this._model},g.handlers=function(){var a=this._handlers;return d.keys(a).reduce(function(b,c){return a[c].reduce(function(a,b){return a.push(b),a},b)},[])},g.on=function(a,d){var f=c(a),g=this._handlers,h=e.select(this._svg).node(),i={type:a,handler:d,svg:b.call(this,d)};return g=g[f]||(g[f]=[]),g.push(i),h.addEventListener(f,i.svg),this},g.off=function(a,b){var d=c(a),f=this._handlers[d],g=e.select(this._svg).node();if(f){for(var h=f.length;--h>=0;)f[h].type===a&&(b&&f[h].handler!==b||(g.removeEventListener(d,f[h].svg),f.splice(h,1)));return this}},f}),f("render/svg/marks",["require","exports","module","d3","../../util/index","../../util/config"],function(a){function b(a){return a.x||0}function c(a){return a.y||0}function d(a){return a.y+a.height||0}function e(a){return null==a.size?100:a.size}function f(a){return a.shape||"circle"}function g(a){var b,c,d,e,f,g=a.mark?a:a.length?a[0]:null;if(null!==g)for(b=0,c=G.length;c>b;++b)d=G[b],e=F[d],f=g[d],null==f?"fill"===e?this.style.setProperty(e,"none",null):this.style.removeProperty(e):(f.id&&(H.current._defs.gradient[f.id]=f,f="url(#"+f.id+")"),this.style.setProperty(e,f+"",null))}function h(a){var b=a.x||0,c=a.y||0;this.setAttribute("transform","translate("+b+","+c+")"),this.setAttribute("d",A(a))}function i(a){if(a.length){var b=a[0];B.interpolate(b.interpolate||"linear").tension(null==b.tension?.7:b.tension),this.setAttribute("d",B(a))}}function j(a){if(a.length){var b=a[0];C.interpolate(b.interpolate||"linear").tension(null==b.tension?.7:b.tension),this.setAttribute("d",C(a))}}function k(a){var b=a.x||0,c=a.y||0;this.setAttribute("transform","translate("+b+","+c+")"),null!=a.path&&this.setAttribute("d",a.path)}function l(a){this.setAttribute("x",a.x||0),this.setAttribute("y",a.y||0),this.setAttribute("width",a.width||0),this.setAttribute("height",a.height||0)}function m(a){var b=a.x||0,c=a.y||0;this.setAttribute("x1",b),this.setAttribute("y1",c),this.setAttribute("x2",null!=a.x2?a.x2:b),this.setAttribute("y2",null!=a.y2?a.y2:c)}function n(a){var b=a.x||0,c=a.y||0;this.setAttribute("transform","translate("+b+","+c+")"),this.setAttribute("d",D(a))}function o(a){var b=a.width||a.image&&a.image.width||0,c=a.height||a.image&&a.image.height||0,d=a.x-("center"===a.align?b/2:"right"===a.align?b:0),e=a.y-("middle"===a.baseline?c/2:"bottom"===a.baseline?c:0),f=z.baseURL+a.url;this.setAttributeNS("http://www.w3.org/1999/xlink","href",f),this.setAttribute("x",d),this.setAttribute("y",e),this.setAttribute("width",b),this.setAttribute("height",c)}function p(a){return(a.fontStyle?a.fontStyle+" ":"")+(a.fontVariant?a.fontVariant+" ":"")+(a.fontWeight?a.fontWeight+" ":"")+(null!=a.fontSize?a.fontSize:z.render.fontSize)+"px "+(a.font||z.render.font)}function q(a){var b=a.x||0,c=a.y||0,d=a.dx||0,e=a.dy||0,f=a.angle||0,g=a.radius||0,h=E[a.align||"left"],i="top"===a.baseline?".9em":"middle"===a.baseline?".35em":0;if(g){var j=(a.theta||0)-Math.PI/2;b+=g*Math.cos(j),c+=g*Math.sin(j)}this.setAttribute("x",b+d),this.setAttribute("y",c+e),this.setAttribute("text-anchor",h),f?this.setAttribute("transform","rotate("+f+" "+b+","+c+")"):this.removeAttribute("transform"),i?this.setAttribute("dy",i):this.removeAttribute("dy"),this.textContent=a.text,this.style.setProperty("font",p(a),null)}function r(a){var b=a.x||0,c=a.y||0;if(this.setAttribute("transform","translate("+b+","+c+")"),a.clip){var d={width:a.width||0,height:a.height||0},e=a.clip_id||(a.clip_id="clip"+H.clip_id++);H.current._defs.clipping[e]=d,this.setAttribute("clip-path","url(#"+e+")")}}function s(a){var b=a.width||0,c=a.height||0;this.setAttribute("width",b),this.setAttribute("height",c)}function t(a){var b="type-"+a.type;return a.name&&(b+=" "+a.name),b}function u(a,b,c){return function(d,e,f){v(d,e,f,"mark_",a,b,c)}}function v(a,b,c,d,e,f,h){var i=h?[b.items]:b.items,j=b.interactive===!1?"none":null,k=a.node().childNodes,l="g"!==e,m=(m=k[c+1])?x.select(m):a.append("g").attr("id","g"+ ++H.mark_id).attr("class",t(b.def)),n=m.attr("id"),o="#"+n+" > "+e,p=m.selectAll(o).data(i),q=p.enter().append(e);return l?(m.style("pointer-events",j),q.each(function(a){a.mark?a._svg=this:a.length&&(a[0]._svg=this)})):q.append("rect").attr("class","background").style("pointer-events",j),p.exit().remove(),p.each(f),l?p.each(g):m.selectAll(o+" > rect.background").each(s).each(g),m}function w(a,b,c,d){var e,f,g,h=v(a,b,c,d||"group_","g",r),i=h.node().childNodes,j=i.length;for(e=0;j>e;++e){var k=i[e].__data__.items,l=i[e].__data__.legendItems||[],m=i[e].__data__.axisItems||[],n=x.select(i[e]),o=0;for(f=0,g=m.length;g>f;++f)"back"===m[f].def.layer&&w.call(this,n,m[f],o++,"axis_");for(f=0,g=k.length;g>f;++f)this.draw(n,k[f],o++);for(f=0,g=m.length;g>f;++f)"back"!==m[f].def.layer&&w.call(this,n,m[f],o++,"axis_");for(f=0,g=l.length;g>f;++f)w.call(this,n,l[f],o++,"legend_")}}var x=a("d3"),y=a("../../util/index"),z=a("../../util/config"),A=x.svg.arc(),B=x.svg.area().x(b).y1(c).y0(d),C=x.svg.line().x(b).y(c),D=x.svg.symbol().type(f).size(e),E={left:"start",center:"middle",right:"end"},F={fill:"fill",fillOpacity:"fill-opacity",stroke:"stroke",strokeWidth:"stroke-width",strokeOpacity:"stroke-opacity",strokeCap:"stroke-linecap",strokeDash:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",opacity:"opacity"},G=y.keys(F),H={update:{group:l,area:i,line:j,arc:h,path:k,symbol:n,rect:l,rule:m,text:q,image:o},nested:{area:!0,line:!0},style:g,draw:{group:w,area:u("path",i,!0),line:u("path",j,!0),arc:u("path",h),path:u("path",k),symbol:u("path",n),rect:u("rect",l),rule:u("line",m),text:u("text",q),image:u("image",o),draw:u},current:null,mark_id:0,clip_id:0};return H}),f("render/svg/Renderer",["require","exports","module","../../util/index","d3","./marks"],function(a){var b=a("../../util/index"),c=a("d3"),d=a("./marks"),e=function(){this._svg=null,this._ctx=null,this._el=null,this._defs={gradient:{},clipping:{}}},f=e.prototype;return f.initialize=function(a,b,d,e){return this._el=a,c.select(a).select("svg.marks").remove(),this._svg=c.select(a).append("svg").attr("class","marks"),this._ctx=this._svg.append("g"),this.resize(b,d,e)},f.resize=function(a,b,c){return this._width=a,this._height=b,this._padding=c,this._svg.attr("width",a+c.left+c.right).attr("height",b+c.top+c.bottom),this._ctx.attr("transform","translate("+c.left+","+c.top+")"),this},f.context=function(){return this._ctx},f.element=function(){return this._el},f.updateDefs=function(){var a,d,e=this._svg,f=this._defs,g=b.keys(f.gradient),h=b.keys(f.clipping),i=e.select("defs");return 0===g.length&&0==h.length?void i.remove():(i.empty()&&(i=e.insert("defs",":first-child")),a=i.selectAll("linearGradient").data(g,b.identity),a.enter().append("linearGradient").attr("id",b.identity),a.exit().remove(),a.each(function(a){var b=f.gradient[a],d=c.select(this);d.attr({x1:b.x1,x2:b.x2,y1:b.y1,y2:b.y2}),stop=d.selectAll("stop").data(b.stops),stop.enter().append("stop"),stop.exit().remove(),stop.attr("offset",function(a){return a.offset}).attr("stop-color",function(a){return a.color})}),d=i.selectAll("clipPath").data(h,b.identity),d.enter().append("clipPath").attr("id",b.identity),d.exit().remove(),void d.each(function(a){var b=f.clipping[a],d=c.select(this).selectAll("rect").data([1]);d.enter().append("rect"),d.attr("x",0).attr("y",0).attr("width",b.width).attr("height",b.height)}))},f.render=function(a,c){d.mark_id=0,d.current=this,c?this.renderItems(b.array(c)):this.draw(this._ctx,a,-1),this.updateDefs(),delete d.current},f.renderItems=function(a){var b,c,e,f,g;for(f=0,g=a.length;g>f;++f)b=a[f],c=b._svg,e=b.mark.marktype,b=d.nested[e]?b.mark.items:b,d.update[e].call(c,b),d.style.call(c,b)},f.draw=function(a,b,c){var e=b.marktype,f=d.draw[e];f&&f.call(this,a,b,c)},e}),f("render/svg/index",["require","exports","module","./Handler","./Renderer"],function(a){return{Handler:a("./Handler"),Renderer:a("./Renderer")}}),f("render/svg-headless/svg",["require","exports","module","d3","../../util/index","../../util/config"],function(a){function b(a,b,c){var d="<"+a;if(b)for(var e in b){var f=b[e];null!=f&&(d+=" "+e+'="'+f+'"')}return c&&(d+=" "+c),d+">"}function c(a){return"</"+a+">"}function d(a){return a=null==a?"":String(a),a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function e(a){return String(a).replace(/\"/g,"'")}function f(a){var d=(a.width||0,a.height||0,a.mark.interactive===!1?'style="pointer-events: none;"':'style=""');return b("rect",{"class":"background"},d)+c("rect")}function g(a,b){var c=a.x||0,d=a.y||0,e={transform:"translate("+c+","+d+")"};if(a.clip){var f={width:a.width||0,height:a.height||0},g=a.clip_id||(a.clip_id="clip"+K++);b.clipping[g]=f,e["clip-path"]="url(#"+g+")"}return e}function h(a){var b=a.x||0,c=a.y||0;return{transform:"translate("+b+","+c+")",d:F(a)}}function i(a){if(a.length){var b=a[0],c="horizontal"===b.orient?H:G;return c.interpolate(b.interpolate||"linear").tension(null==b.tension?.7:b.tension),{d:c(a)}}}function j(a){if(a.length){var b=a[0];return I.interpolate(b.interpolate||"linear").tension(null==b.tension?.7:b.tension),{d:I(a)}}}function k(a){var b=a.x||0,c=a.y||0;return{transform:"translate("+b+","+c+")",d:a.path}}function l(a){return{x:a.x||0,y:a.y||0,width:a.width||0,height:a.height||0}}function m(a){var b=a.x||0,c=a.y||0;return{x1:b,y1:c,x2:null!=a.x2?a.x2:b,y2:null!=a.y2?a.y2:c}}function n(a){var b=a.x||0,c=a.y||0;return{transform:"translate("+b+","+c+")",d:J(a)}}function o(a){var b=a.width||a.image&&a.image.width||0,c=a.height||a.image&&a.image.height||0,d=a.x-("center"===a.align?b/2:"right"===a.align?b:0),e=a.y-("middle"===a.baseline?c/2:"bottom"===a.baseline?c:0),f=B.baseURL+a.url;return{"xlink:href":f,x:d,y:e,width:b,height:c}}function p(a){var b=a.x||0,c=a.y||0,d=a.dx||0,e=a.dy||0,f=a.angle||0,g=a.radius||0,h=L[a.align||"left"],i="top"===a.baseline?".9em":"middle"===a.baseline?".35em":0;if(g){var j=(a.theta||0)-Math.PI/2;b+=g*Math.cos(j),c+=g*Math.sin(j)}return{x:b+d,y:c+e,"text-anchor":h,transform:f?"rotate("+f+" "+b+","+c+")":null,dy:i?i:null}}function q(a){var b="type-"+a.type;return a.name&&(b+=" "+a.name),b}function r(a){return a.x||0}function s(a){return a.y||0}function t(a){return a.x+a.width||0}function u(a){return a.y+a.height||0}function v(a){return null==a.size?100:a.size}function w(a){return a.shape||"circle"}function x(a,b,c){var d,e,f,g,h,i=a.mark?a:a.length?a[0]:null;if(null===i)return null;var j="";for("text"===b&&(j+="font: "+y(i)+";"),d=0,e=N.length;e>d;++d)f=N[d],g=M[f],h=i[f],null==h?"fill"===g&&(j+="fill: none;"):(h.id&&(c.gradient[h.id]=h,h="url("+window.location.href+"#"+h.id+")"),j+=(j.length?" ":"")+g+": "+h+";");return'style="'+j+'"'}function y(a){var b=(a.fontStyle?a.fontStyle+" ":"")+(a.fontVariant?a.fontVariant+" ":"")+(a.fontWeight?a.fontWeight+" ":"")+(null!=a.fontSize?a.fontSize:B.render.fontSize)+"px "+(a.font&&e(a.font)||B.render.font);return b}var z=a("d3"),A=a("../../util/index"),B=a("../../util/config"),C=function(){this._gid=0,this._text={head:"",root:"",foot:"",defs:"",body:""},this._defs={gradient:{},clipping:{}}},D=C.prototype;D.initialize=function(a,d,e,f){var g=this._text;g.head=b("svg",{"class":"marks",width:d+f.left+f.right,height:e+f.top+f.bottom},B.svgNamespace),g.root=b("g",{transform:"translate("+f.left+","+f.top+")"}),g.foot=c("g")+c("svg")},D.svg=function(){var a=this._text;return a.head+a.defs+a.root+a.body+a.foot},D.buildDefs=function(){var a,d,e=this._defs,f=A.keys(e.gradient),g=A.keys(e.clipping),h="";for(a=0;a<f.length;++a){var i=f[a],j=e.gradient[i],k=j.stops;for(h+=b("linearGradient",{id:i,x1:j.x1,x2:j.x2,y1:j.y1,y2:j.y2}),d=0;d<k.length;++d)h+=b("stop",{offset:k[d].offset,"stop-color":k[d].color})+c("stop");
h+=c("linearGradient")}for(a=0;a<g.length;++a){var i=g[a],j=e.clipping[i];h+=b("clipPath",{id:i}),h+=b("rect",{x:0,y:0,width:j.width,height:j.height})+c("rect"),h+=c("clipPath")}return h.length>0?b("defs")+h+c("defs"):""},D.render=function(a){this._gid=0,this._text.body=this.draw(a),this._text.defs=this.buildDefs()},D.draw=function(a){var e=E[a.marktype];if(e){var f,g,h=e[0],i=e[1],j=e[2]||!1,k=j?[a.items]:a.items,l=this._defs,m="",n=q(a.def),o=null;for("type-rule"===n||"type-path"===n?o='style="pointer-events: none;"':"type-group"!==n&&(o='style=""'),m+=b("g",{id:"g"+ ++this._gid,"class":q(a.def)},o),f=0;f<k.length;++f){var g="g"===h?null:x(k[f],h,l);m+=b(h,i(k[f],l),g),"text"===h&&(m+=d(k[f].text)),"g"===h&&(m+=this.drawGroup(k[f])),m+=c(h)}return m+c("g")}};var E={group:["g",g],area:["path",i,!0],line:["path",j,!0],arc:["path",h],path:["path",k],symbol:["path",n],rect:["rect",l],rule:["line",m],text:["text",p],image:["image",o]};D.drawGroup=function(a){var b,c,d="",e=a.axisItems||[],g=a.items,h=a.legendItems||[];for(d+=f(a),b=0,c=e.length;c>b;++b)"back"===e[b].def.layer&&(d+=this.draw(e[b]));for(b=0,c=g.length;c>b;++b)d+=this.draw(g[b]);for(b=0,c=e.length;c>b;++b)"back"!==e[b].def.layer&&(d+=this.draw(e[b]));for(b=0,c=h.length;c>b;++b)d+=this.draw(h[b]);return d};var F=z.svg.arc(),G=z.svg.area().x(r).y1(s).y0(u),H=z.svg.area().y(s).x0(t).x1(r),I=z.svg.line().x(r).y(s),J=z.svg.symbol().type(w).size(v),K=0,L={left:"start",center:"middle",right:"end"},M={fill:"fill",fillOpacity:"fill-opacity",stroke:"stroke",strokeWidth:"stroke-width",strokeOpacity:"stroke-opacity",strokeCap:"stroke-linecap",strokeDash:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",opacity:"opacity"},N=A.keys(M);return C}),f("render/svg-headless/Renderer",["require","exports","module","d3","../../util/index","../../util/config","./svg"],function(a){var b=(a("d3"),a("../../util/index")),c=(a("../../util/config"),function(){this._builder=null}),d=c.prototype;return d.initialize=function(b,c,d,e){var f=a("./svg");return this._builder=new f,this.resize(c,d,e)},d.resize=function(a,c,d){this._width=a,this._height=c,this._padding=d||{top:0,left:0,bottom:0,right:0},this._autopad=b.isString(this._padding)?1:0;var e=this._width,f=this._height,d=this._padding;return this._builder.initialize(null,e,f,d),this},d.render=function(a){return this._builder.render(a),this},d.svg=function(){return this._builder.svg()},c}),f("render/svg-headless/index",["require","exports","module","./Renderer"],function(a){return{Renderer:a("./Renderer")}}),f("scene/Transition",["require","exports","module","../dataflow/tuple","../util/bounds","../util/constants"],function(b){function c(b,c){this.duration=b||500,this.ease=c&&a.ease(c)||a.ease("cubic-in-out"),this.updates={next:null}}function d(a){for(var b,c,d,e,g,h,i=this.updates,j=i,k=j.next,l=this.duration,m=!0;null!=k;j=k,k=j.next)if(b=k.item,c=b.delay||0,d=(a-c)/l,0>d)m=!1;else{for(d>1&&(d=1),e=k.ease(d),g=0,h=k.length;h>g;++g)b[k[g].property]=k[g](e);b.touch(),f.item(b),1===d?(k.remove&&b.remove(),j.next=k.next,k=j):m=!1}return this.callback(),m}var e=b("../dataflow/tuple"),f=b("../util/bounds"),g=b("../util/constants"),h=c.prototype,i={text:1,url:1};return h.interpolate=function(b,c){var d,f,h,j,k=null;for(d in c)f=b[d],h=c[d],f!==h&&(i[d]||void 0===f?e.set(b,d,h):"number"!=typeof f||isFinite(f)?(j=a.interpolate(f,h),j.property=d,(k||(k=[])).push(j)):e.set(b,d,h));return null===k&&b.status===g.EXIT&&(k=[]),null!=k&&(k.item=b,k.ease=b.mark.ease||this.ease,k.next=this.updates.next,this.updates.next=k),this},h.start=function(b){for(var c=this,e=c.updates,f=e.next;null!=f;e=f,f=e.next)f.item.status===g.EXIT&&(f.remove=!0);c.callback=b,a.timer(function(a){return d.call(c,a)})},c}),f("core/View",["require","exports","module","d3","../dataflow/Node","../parse/streams","../render/canvas/index","../render/svg/index","../render/svg-headless/index","../scene/Transition","../util/config","../util/index","../dataflow/changeset"],function(a){var b=a("d3"),c=a("../dataflow/Node"),d=a("../parse/streams"),e=a("../render/canvas/index"),f=a("../render/svg/index"),g=a("../render/svg-headless/index"),h=a("../scene/Transition"),i=a("../util/config"),j=a("../util/index"),k=a("../dataflow/changeset"),l=function(a,b,c){this._el=null,this._model=null,this._width=this.__width=b||500,this._height=this.__height=c||300,this._autopad=1,this._padding={top:0,left:0,bottom:0,right:0},this._viewport=null,this._renderer=null,this._handler=null,this._io=e,this.initialize(a||null)},m=l.prototype;return m.model=function(a){return arguments.length?(this._model!==a&&(this._model=a,this._handler&&this._handler.model(a)),this):this._model},m.data=function(a){var b=this.model();return arguments.length?(j.keys(a).forEach(function(c){b.data(c).add(j.duplicate(a[c]))}),this):b.data()},m.width=function(a){return arguments.length?(this.__width!==a&&(this._width=this.__width=a,this.reinit(),this._strict&&(this._autopad=1)),this):this.__width},m.height=function(a){return arguments.length?(this.__height!==a&&(this._height=this.__height=a,this.reinit(),this._strict&&(this._autopad=1)),this):this.__height},m.padding=function(a){return arguments.length?(this._padding!==a&&(j.isString(a)?(this._autopad=1,this._padding={top:0,left:0,bottom:0,right:0},this._strict="strict"===a):(this._autopad=0,this._padding=a,this._strict=!1),this._renderer.resize(this._width,this._height,a),this._el&&this._handler.padding(a)),this):this._padding},m.autopad=function(a){if(this._autopad<1)return this;this._autopad=0;var b=this._padding,c=this.model().scene().bounds,d=i.autopadInset,e=c.x1<0?Math.ceil(-c.x1)+d:0,f=c.y1<0?Math.ceil(-c.y1)+d:0,g=c.x2>this._width?Math.ceil(+c.x2-this._width)+d:0,c=c.y2>this._height?Math.ceil(+c.y2-this._height)+d:0;return b={left:e,top:f,right:g,bottom:c},this._strict?(this._autopad=0,this._padding=b,this._width=Math.max(0,this.__width-(e+g)),this._height=Math.max(0,this.__height-(f+c)),this._model.width(this._width),this._model.height(this._height),this.reinit(),this.update()):this.padding(b).update(a),this},m.viewport=function(a){return arguments.length?(this._viewport!==a&&(this._viewport=a,this.reinit()),this):this._viewport},m.renderer=function(a){if(!arguments.length)return this._renderer;if("canvas"===a)a=e;else if("svg"===a)a=f;else if("svg-headless"===a)a=g;else{if(j.isString(a))throw new Error("Unknown renderer: "+a);if(!a)throw new Error("No renderer specified")}return this._io!==a&&(this._io=a,this._renderer=null,this.reinit(),this._build&&this.render()),this},m.reinit=function(){this.initialize(this._el?this._el.parentNode:null)},m.initialize=function(a){var c,e=this,f=e._width,g=e._height,h=e._padding;return a&&(b.select(a).select("div.vega").remove(),this._el=a=b.select(a).append("div").attr("class","vega").style("position","relative").node(),e._viewport&&b.select(a).style("width",(e._viewport[0]||f)+"px").style("height",(e._viewport[1]||g)+"px").style("overflow","auto")),e._renderer=(e._renderer||new this._io.Renderer).initialize(a,f,g,h),a&&(c=e._handler,e._handler=(new this._io.Handler).initialize(a,h,e).model(e._model),c?c.handlers().forEach(function(a){e._handler.on(a.type,a.handler)}):d(this)),this},m.update=function(a){a=a||{};var b=this,d=a.duration?new h(a.duration,a.ease):null,e=k.create();return d&&(e.trans=d),void 0!==a.reflow&&(e.reflow=a.reflow),b._build||(b._renderNode=new c(b._model.graph).router(!0),b._renderNode.evaluate=function(a){j.debug(a,["rendering"]);var c=b._model.scene();a.trans?a.trans.start(function(a){b._renderer.render(c,a)}):b._renderer.render(c);var d,e;for(d in a.data)e=b._model.data(d),e.revises()&&k.finalize(e.last());return a},b._model.scene(b._renderNode),b._build=!0),b._model.fire(e),b.autopad(a)},m.on=function(){return this._handler.on.apply(this._handler,arguments),this},m.off=function(){return this._handler.off.apply(this._handler,arguments),this},l.factory=function(a){return function(b){b=b||{};var c=a.defs(),d=(new l).model(a).width(c.width).height(c.height).padding(c.padding).renderer(b.renderer||"canvas");return d.initialize(b.el||null),b.data&&d.data(b.data),d}},l}),f("parse/padding",["require","exports","module","../util/index"],function(a){var b=a("../util/index");return function(a){if(null==a)return"auto";if(b.isString(a))return"strict"===a?"strict":"auto";if(b.isObject(a))return a;var c=b.isNumber(a)?a:20;return{top:c,left:c,right:c,bottom:c}}}),f("parse/marks",["require","exports","module","./mark"],function(a){var b=a("./mark");return function(a,c,d,e){return{type:"group",width:d,height:e,scales:c.scales||[],axes:c.axes||[],marks:(c.marks||[]).map(function(c){return b(a,c)})}}}),f("parse/signals",["require","exports","module","./expr","../util/constants"],function(a){var b=a("./expr"),c=a("../util/constants");return function(a,d){var e=a.graph;return(d||[]).forEach(function(f){var g,h=e.signal(f.name,f.init);f.expr&&(g=b(e,f.expr),h.evaluate=function(c){var i=b.eval(e,g.fn,null,null,null,null,g.signals);return d.scale&&(i=a.scale(d,i)),h.value(i),c.signals[f.name]=1,c},h.dependency(c.SIGNALS,g.signals),g.signals.forEach(function(a){e.signal(a).addListener(h)}))}),d}}),f("parse/predicates",["require","exports","module","../util/index"],function(a){var b=a("../util/index");return function(a,c){function d(a,c){var d=b.field(a),e="signals["+d.map(b.str).join("][")+"]";return c[d.shift()]=1,e}function e(c){var e=[],f=[],g={},h={};return b.array(c).forEach(function(c,i){var j="o"+i,k="";if(void 0!==c.value)k=b.str(c.value);else if(c.arg)k="args["+b.str(c.arg)+"]";else if(c.signal)k=d(c.signal,g);else if(c.predicate){var l=a.predicate(c.predicate);l.signals.forEach(function(a){g[a]=1}),l.data.forEach(function(a){h[a]=1}),b.keys(c.input).forEach(function(a){var e=c.input[a];k+="args["+b.str(a)+"] = ",e.signal?k+=d(e.signal,g):e.arg&&(k+="args["+b.str(e.arg)+"]"),k+=", "}),k+="predicates["+b.str(c.predicate)+"](args, db, signals, predicates)"}e.push(j),f.push(j+"=("+k+")")}),{code:"var "+e.join(", ")+";\n"+f.join(";\n")+";\n",signals:b.keys(g),data:b.keys(h)}}function f(a){var b=e(a.operands);return"="==a.type&&(a.type="=="),{code:b.code+"return "+["o0","o1"].join(a.type)+";",signals:b.signals,data:b.data}}function g(a){for(var b=e(a.operands),c=[],d=0,f=a.operands.length;c.push("o"+d++)<f;);return"and"==a.type?a.type="&&":"or"==a.type&&(a.type="||"),{code:b.code+"return "+c.join(a.type)+";",signals:b.signals,data:b.data}}function h(a){var c=[a.item];a.range&&c.push.apply(c,a.range),a.scale&&c.push(a.scale);var d=e(c),f=d.code;if(a.data){var g=b.field(a.field).map(b.str);f+="var where = function(d) { return d["+g.join("][")+"] == o0 };\n",f+="return db["+b.str(a.data)+"].filter(where).length > 0;"}else a.range&&(a.scale&&(f+="o1 = o3(o1);\no2 = o3(o2);\n"),f+="return o1 < o2 ? o1 <= o0 && o0 <= o2 : o2 <= o0 && o0 <= o1");return{code:f,signals:d.signals,data:d.data.concat(a.data?[a.data]:[])}}var i={"=":f,"==":f,"!=":f,">":f,">=":f,"<":f,"<=":f,and:g,"&&":g,or:g,"||":g,"in":h};return(c||[]).forEach(function(b){var c=i[b.type](b),d=Function("args","db","signals","predicates",c.code);d.signals=c.signals,d.data=c.data,a.predicate(b.name,d)}),c}}),f("parse/interactors",["require","exports","module","../util/load","../util/index","../util/constants"],function(a){var b=a("../util/load"),c=a("../util/index"),d=a("../util/constants");return function(a,e,f){function g(a){return function(b,d){if(b)c.error("LOADING FAILED: "+a.url);else{var e=c.isObject(d)?d:JSON.parse(d);h(a.name,e)}0==--q&&i()}}function h(a,b){r={},s={},b.signals&&u.push.apply(u,l(a,b.signals)),b.predicates&&v.push.apply(v,m(a,b.predicates)),o(a,b.marks)}function i(){c.keys(t).length>0&&j(e.marks),e.signals=c.array(e.signals),e.predicates=c.array(e.predicates),e.signals.unshift.apply(e.signals,u),e.predicates.unshift.apply(e.predicates,v),f()}function j(a){var b,e,f,g;for(a=c.array(a),f=0,g=a.length;g>f;f++)b=a[f],(e=t[b.type])?(a[f]=c.duplicate(e),b.from&&(a[f].from=b.from),b.properties&&[d.ENTER,d.UPDATE,d.EXIT].forEach(function(d){a[f].properties[d]=c.extend(e.properties[d],b.properties[d])})):b.marks&&j(b.marks)}function k(a,b){return c.isString(b)?b+"_"+a:(c.keys(b).forEach(function(c){var d=new RegExp("\\b"+c+"\\b","g");a=a.replace(d,b[c])}),a)}function l(a,b){return b=c.array(b),b.forEach(function(b){b.name=r[b.name]=k(b.name,a)}),b.forEach(function(a){(a.streams||[]).forEach(function(a){a.type=k(a.type,r),a.expr=k(a.expr,r)})}),b}function m(a,b){return b=c.array(b),b.forEach(function(b){b.name=s[b.name]=k(b.name,a),[b.operands,b.range].forEach(function(a){(a||[]).forEach(function(a){a.signal?a.signal=k(a.signal,r):a.predicate&&n(a)})})}),b}function n(a){a.predicate=s[a.predicate],c.keys(a.input).forEach(function(b){var c=a.input[b];c.signal&&(c.signal=k(c.signal,r))})}function o(a,b){(b||[]).forEach(function(b){p(b.properties.enter),p(b.properties.update),p(b.properties.exit),t[k(b.name,a)]=b})}function p(a){c.keys(a).forEach(function(b){var c=a[b];c.signal?c.signal=k(c.signal,r):c.rule&&c.rule.forEach(function(a){a.signal&&(a.signal=k(a.signal,r)),a.predicate&&n(a)})})}var q=0,r={},s={},t={},u=[],v=[];return(e.interactors||[]).forEach(function(a){a.url&&(q+=1,b(a.url,g(a)))}),0===q&&i(),e}}),f("parse/spec",["require","exports","module","../core/Model","../core/View","../parse/padding","../parse/marks","../parse/signals","../parse/predicates","../parse/data","../parse/interactors","../util/index"],function(a){var b=a("../core/Model"),c=a("../core/View"),d=a("../parse/padding"),e=a("../parse/marks"),f=a("../parse/signals"),g=a("../parse/predicates"),h=a("../parse/data"),i=a("../parse/interactors"),j=a("../util/index");return function(a,k,l){a=j.duplicate(a),l=l||c.factory;var m=a.width||500,n=a.height||500,o=a.viewport||null,p=new b;i(p,a,function(){p.defs({width:m,height:n,viewport:o,padding:d(a.padding),signals:f(p,a.signals),predicates:g(p,a.predicates),marks:e(p,a,m,n)}),h(p,a.data,function(){k(l(p))})})}}),f("d3",[],function(){return a}),f("topojson",[],function(){return b}),{core:{View:e("core/View")},dataflow:{changeset:e("dataflow/changeset"),Datasource:e("dataflow/Datasource"),Graph:e("dataflow/Graph"),Node:e("dataflow/Node")},parse:{spec:e("parse/spec")},scene:{Builder:e("scene/Builder"),GroupBuilder:e("scene/GroupBuilder")},util:e("util/index"),config:e("util/config"),importModule:f}});